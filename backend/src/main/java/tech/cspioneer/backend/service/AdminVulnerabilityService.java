package tech.cspioneer.backend.service;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tech.cspioneer.backend.common.ApiException;
import tech.cspioneer.backend.entity.User;
import tech.cspioneer.backend.entity.VulnerabilityMetadata;
import tech.cspioneer.backend.enums.VulnerabilityStatus;
import tech.cspioneer.backend.mapper.UserMapper;
import tech.cspioneer.backend.mapper.OrganizationMapper;
import tech.cspioneer.backend.mapper.VulnerabilityMetadataMapper;

import java.time.LocalDateTime;

@Service
public class AdminVulnerabilityService {
    private final VulnerabilityMetadataMapper vmMapper;
    private final UserMapper userMapper;
    private final tech.cspioneer.backend.mapper.NotificationMapper notificationMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityProjectMapper projectMapper;
    private final tech.cspioneer.backend.mapper.LnkVulnTagMapper linkTagMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityAffectedPackageMapper affectedPackageMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityAffectedRangeMapper affectedRangeMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityAffectedRangeEventMapper affectedRangeEventMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityAffectedVersionMapper affectedVersionMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityAffectedCommitMapper affectedCommitMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityPatchDetailMapper patchDetailMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityPatchBranchMapper patchBranchMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityPatchTagMapper patchTagMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataAliasMapper aliasMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataRelatedMapper relatedMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataReferenceMapper referenceMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataCweMapper cweMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataTimelineMapper timelineMapper;
    private final tech.cspioneer.backend.mapper.VulnerabilityMetadataSeverityMapper severityMapper;
    private final PointsPolicyService pointsPolicyService;
    private final PointsService pointsService;
    private final OrganizationMapper organizationMapper;

    public AdminVulnerabilityService(VulnerabilityMetadataMapper vmMapper,
                                     UserMapper userMapper,
                                     tech.cspioneer.backend.mapper.NotificationMapper notificationMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityProjectMapper projectMapper,
                                     tech.cspioneer.backend.mapper.LnkVulnTagMapper linkTagMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityAffectedPackageMapper affectedPackageMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityAffectedRangeMapper affectedRangeMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityAffectedRangeEventMapper affectedRangeEventMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityAffectedVersionMapper affectedVersionMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityAffectedCommitMapper affectedCommitMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityPatchDetailMapper patchDetailMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityPatchBranchMapper patchBranchMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityPatchTagMapper patchTagMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataAliasMapper aliasMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataRelatedMapper relatedMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataReferenceMapper referenceMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataCweMapper cweMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataTimelineMapper timelineMapper,
                                     tech.cspioneer.backend.mapper.VulnerabilityMetadataSeverityMapper severityMapper,
                                     PointsPolicyService pointsPolicyService,
                                     PointsService pointsService,
                                     OrganizationMapper organizationMapper,
                                     org.springframework.beans.factory.ObjectProvider<tech.cspioneer.backend.search.EsIndexer> esIndexerProvider) {
        this.vmMapper = vmMapper;
        this.userMapper = userMapper;
        this.notificationMapper = notificationMapper;
        this.projectMapper = projectMapper;
        this.linkTagMapper = linkTagMapper;
        this.affectedPackageMapper = affectedPackageMapper;
        this.affectedRangeMapper = affectedRangeMapper;
        this.affectedRangeEventMapper = affectedRangeEventMapper;
        this.affectedVersionMapper = affectedVersionMapper;
        this.affectedCommitMapper = affectedCommitMapper;
        this.patchDetailMapper = patchDetailMapper;
        this.patchBranchMapper = patchBranchMapper;
        this.patchTagMapper = patchTagMapper;
        this.aliasMapper = aliasMapper;
        this.relatedMapper = relatedMapper;
        this.referenceMapper = referenceMapper;
        this.cweMapper = cweMapper;
        this.timelineMapper = timelineMapper;
        this.severityMapper = severityMapper;
        this.pointsPolicyService = pointsPolicyService;
        this.pointsService = pointsService;
        this.organizationMapper = organizationMapper;
        this.esIndexer = esIndexerProvider.getIfAvailable();
    }

    private final tech.cspioneer.backend.search.EsIndexer esIndexer;

    @Transactional
    public VulnerabilityMetadata updateStatus(String adminUuid, String vulnUuid, String status, String rejectReason) {
        VulnerabilityMetadata vm = vmMapper.findByUuid(vulnUuid);
        if (vm == null) throw new ApiException(404, "漏洞不存在");
        if (status == null || status.isBlank()) throw new ApiException(1001, "status 不能为空");
        VulnerabilityStatus vs;
        try { vs = VulnerabilityStatus.fromCode(status.trim()); } catch (Exception e) { throw new ApiException(1001, "不支持的status"); }
        VulnerabilityStatus oldStatus = vm.getStatus();
        User admin = userMapper.findByUuid(adminUuid);
        Long reviewerId = admin != null ? admin.getId() : null;
        LocalDateTime reviewDate = LocalDateTime.now();
        vmMapper.updateStatusReviewByUuid(vulnUuid, vs.getCode(), rejectReason, rejectReason != null, reviewDate, reviewerId);
        VulnerabilityMetadata updated = vmMapper.findByUuid(vulnUuid);
        // 通知创建者审核结果
        if (updated != null && updated.getUserId() != null) {
            tech.cspioneer.backend.entity.Notification n = new tech.cspioneer.backend.entity.Notification();
            n.setUuid(java.util.UUID.randomUUID().toString());
            n.setType(tech.cspioneer.backend.enums.NotificationType.VULNERABILITY_REPORT);
            n.setTargetId(updated.getId());
            n.setUserId(updated.getUserId());
            n.setSenderId(reviewerId);
            n.setTitle("漏洞审核结果");
            String msg = "漏洞 " + updated.getIdentifier() + " 审核为 " + vs.getCode();
            if (vs == VulnerabilityStatus.REJECTED && rejectReason != null && !rejectReason.isBlank()) {
                msg += "（原因：" + rejectReason + ")";
            }
            n.setContent(msg);
            n.setIsRead(false);
            n.setStatus(tech.cspioneer.backend.enums.NotificationStatus.ACTIVE);
            notificationMapper.insert(n);
            try { notificationMapper.updateActionUrlByUuid(n.getUuid(), "/vulnerabilities/" + updated.getUuid()); } catch (Exception ignore) {}
        }
        if (esIndexer != null && updated != null) {
            try { esIndexer.indexOne(updated.getUuid()); } catch (Exception ignore) {}
        }

        // 当审核将状态置为 ACTIVE 时，发放 PUBLISHED 积分（幂等保护）
        try {
            if (updated != null && oldStatus != VulnerabilityStatus.ACTIVE && vs == VulnerabilityStatus.ACTIVE) {
                String submitterUuid = null;
                if (updated.getUserId() != null) submitterUuid = userMapper.findUuidById(updated.getUserId());
                String orgUuid = null;
                if (updated.getOrganizationId() != null) {
                    var org = organizationMapper.findById(updated.getOrganizationId());
                    if (org != null) orgUuid = org.getUuid();
                }
                PointsPolicyService.PreviewReq r = new PointsPolicyService.PreviewReq();
                r.event = "PUBLISHED";
                r.severityNum = updated.getSeverityNum() == null ? null : updated.getSeverityNum().doubleValue();
                r.severityLevel = null;
                var out = (orgUuid != null && !orgUuid.isBlank()) ? pointsPolicyService.previewForOrg(orgUuid, r) : pointsPolicyService.preview(r);
                String idem = "vuln:" + updated.getUuid() + ":PUBLISHED";
                String refType = "VULN";
                String reason = "VULN_PUBLISHED";
                if (submitterUuid != null && out.userDelta != 0) {
                    pointsService.addUserPoints(submitterUuid, out.userDelta, reason, refType, updated.getUuid(), idem);
                }
                if (orgUuid != null && !orgUuid.isBlank() && out.orgDelta != 0) {
                    pointsService.addOrgPoints(orgUuid, out.orgDelta, reason, refType, updated.getUuid(), idem);
                }
            }
        } catch (Exception ignore) {}
        return updated;
    }

    @Transactional
    public void delete(String vulnUuid) {
        VulnerabilityMetadata vm = vmMapper.findByUuid(vulnUuid);
        if (vm == null) throw new ApiException(404, "漏洞不存在");
        // 软删除：设置状态为 DELETED，并更新时间
        vmMapper.updateStatusReviewByUuid(vulnUuid, tech.cspioneer.backend.enums.VulnerabilityStatus.DELETED.getCode(), null, false, null, null);
        if (esIndexer != null) {
            try { esIndexer.deleteOne(vulnUuid); } catch (Exception ignore) {}
        }
    }
}
