-- COSV Horizon 完整漏洞测试数据（包含所有相关表）
-- 注意：本脚本使用显式 ID，避免依赖自增结果；如有冲突请先清理或调整 ID。
-- 适用数据库：MySQL 8.x（或兼容）

START TRANSACTION;

-- ========== 预清理：按 UUID/标识符 删除可能已有的同名数据 ==========
DELETE FROM vulnerability_metadata_exploit_status WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_credit_contact WHERE credit_id IN (SELECT id FROM vulnerability_metadata_credit WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_credit WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_contributor WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_patch_tag WHERE patch_detail_id IN (SELECT id FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_patch_branch WHERE patch_detail_id IN (SELECT id FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_affected_range_event WHERE range_id IN (SELECT id FROM vulnerability_metadata_affected_range WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501')));
DELETE FROM vulnerability_metadata_affected_range WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_affected_version WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_affected_commit WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501'));
DELETE FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_severity WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_timeline WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_cwe WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_reference WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_alias WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_related WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM lnk_vulnerability_metadata_tag WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM lnk_vulnerability_metadata_user WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata_project WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501');
DELETE FROM vulnerability_metadata WHERE uuid = '00000000-0000-4000-8000-000000000501' OR identifier = 'COSV-2025-000001';
DELETE FROM cosv_file WHERE uuid = '00000000-0000-4000-8000-000000000601' OR identifier = 'COSV-2025-000001';

-- 清理标签/分类（按 code/uuid）
DELETE FROM lnk_vulnerability_metadata_tag WHERE tag_id IN (SELECT id FROM tag WHERE code IN ('WEB','CWE-444','RCE'));
DELETE FROM tag WHERE uuid IN ('tag-00000000-0000-4000-8000-000000000001','tag-00000000-0000-4000-8000-000000000002','tag-00000000-0000-4000-8000-000000000003') OR code IN ('WEB','CWE-444','RCE');
DELETE FROM category WHERE uuid = 'cat-00000000-0000-4000-8000-000000000001' OR code = 'HTTP_SMUGGLING';

-- 清理用户/组织（按 uuid/name）
DELETE FROM lnk_user_organization WHERE uuid = '00000000-0000-4000-8000-000000000301';
DELETE FROM organization WHERE uuid = '00000000-0000-4000-8000-000000000101' OR name = 'Acme Security';
DELETE FROM user WHERE uuid IN ('00000000-0000-4000-8000-000000000001','00000000-0000-4000-8000-000000000002') OR name IN ('tester','admin2');

-- ========== 基础字典：用户、组织、分类、标签 ==========
INSERT INTO user (id, uuid, name, password, role, email, avatar, company, location, git_hub, status, rating, website, free_text, real_name)
VALUES
  (1001, '00000000-0000-4000-8000-000000000001', 'tester', '$2a$10$hash', 'USER', 'tester@example.com', NULL, 'Acme Corp', 'Shenzhen, CN', 'https://github.com/tester', 'ACTIVE', 120, 'https://tester.dev', 'Security researcher', '张三'),
  (1002, '00000000-0000-4000-8000-000000000002', 'admin2', '$2a$10$hash', 'ADMIN', 'admin2@example.com', NULL, 'Acme Corp', 'Shenzhen, CN', NULL, 'ACTIVE', 999, NULL, 'System admin', '李四');

INSERT INTO organization (id, uuid, name, status, avatar, description, rating, free_text, is_public, allow_join_request, allow_invite_link)
VALUES (2001, '00000000-0000-4000-8000-000000000101', 'Acme Security', 'ACTIVE', NULL, 'Security org for testing', 88, 'We secure open source.', 1, 1, 1);

INSERT INTO lnk_user_organization (id, uuid, organization_id, user_id, role)
VALUES (3001, '00000000-0000-4000-8000-000000000301', 2001, 1001, 'ADMIN');

INSERT INTO category (id, uuid, code, name, description)
VALUES (4001, '00000000-0000-4000-8000-000000000401', 'HTTP_SMUGGLING', 'HTTP Request Smuggling', 'Smuggling via malformed request parsing');

INSERT INTO tag (id, uuid, code, name)
VALUES
  (7001, '00000000-0000-4000-8000-000000000701', 'WEB', 'Web'),
  (7002, '00000000-0000-4000-8000-000000000702', 'CWE-444', 'HTTP Request Smuggling'),
  (7003, '00000000-0000-4000-8000-000000000703', 'RCE', 'Remote Code Execution');

-- ========== COSV 文件版本（最新一版） ==========
INSERT INTO cosv_file (id, uuid, identifier, modified, prev_cosv_file_id, user_id, schema_version, raw_cosv_file_id)
VALUES (6001, '00000000-0000-4000-8000-000000000601', 'COSV-2025-000001', NOW(), NULL, 1001, '1.0.0', NULL);

-- ========== 漏洞主体 ==========
INSERT INTO vulnerability_metadata (
  id, uuid, identifier, summary, details, severity_num, modified, submitted, published, withdrawn,
  language, status, user_id, organization_id, category_id, latest_cosv_file_id, schema_version,
  review_date, reviewed_by, reject_reason, confirmed_type, database_specific
) VALUES (
  5001,
  '00000000-0000-4000-8000-000000000501',
  'COSV-2025-000001',
  'HTTP 请求走私导致前端代理绕过与缓存投毒',
  '受影响版本在处理分块请求与 Content-Length 头时解析不一致，攻击者可构造走私请求绕过WAF或污染下游缓存。\n\n影响：认证绕过、缓存投毒、请求伪造。\n缓解：升级至最新版本或启用一致性解析。',
  7.8,
  NOW(),
  '2025-07-15 12:00:00',
  '2025-07-16 09:00:00',
  '2025-07-20 00:00:00',
  'PYTHON',
  'ACTIVE',
  1001,
  2001,
  4001,
  6001,
  '1.0.0',
  '2025-07-16 10:00:00',
  1002,
  'N/A',
  'manual_confirmed',
  '{"source":"internal","cvss":"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:M/A:L","hot":true}'
);

-- 关联标签
INSERT INTO lnk_vulnerability_metadata_tag (id, vulnerability_metadata_id, tag_id) VALUES
  (9001, 5001, 7001),
  (9002, 5001, 7002),
  (9003, 5001, 7003);

-- 关联用户（示例：把创建者也登记为关联人）
INSERT INTO lnk_vulnerability_metadata_user (id, vulnerability_metadata_id, user_id) VALUES (9101, 5001, 1001);

-- 相关项目（示例数据）
INSERT INTO vulnerability_metadata_project (id, uuid, name, url, versions, vulnerability_metadata_id, type) VALUES
  (5201, '00000000-0000-4000-8000-000000000521', 'aiohttp', 'https://github.com/aio-libs/aiohttp', '3.12.0,3.12.1,3.12.2', 5001, 'AFFECTED');

-- ========== COSV 子结构：别名/相关/引用/CWE/时间线/多量表严重性 ==========
INSERT INTO vulnerability_metadata_alias (id, vulnerability_metadata_id, value) VALUES
  (5301, 5001, 'CVE-2025-53643'),
  (5302, 5001, 'GHSA-xxxx-xxxx');

INSERT INTO vulnerability_metadata_related (id, vulnerability_metadata_id, value) VALUES
  (5311, 5001, 'CVE-2024-11111');

INSERT INTO vulnerability_metadata_reference (id, vulnerability_metadata_id, type, url) VALUES
  (5321, 5001, 'advisory', 'https://nvd.nist.gov/vuln/detail/CVE-2025-53643'),
  (5322, 5001, 'patch', 'https://github.com/aio-libs/aiohttp/commit/abcdef1234567890');

INSERT INTO vulnerability_metadata_cwe (id, vulnerability_metadata_id, cwe_id, cwe_name) VALUES
  (5331, 5001, 'CWE-444', 'HTTP Request Smuggling'),
  (5332, 5001, 'CWE-346', 'Origin Validation Error');

INSERT INTO vulnerability_metadata_timeline (id, vulnerability_metadata_id, type, value) VALUES
  (5341, 5001, 'disclosed', '2025-07-15 00:00:00'),
  (5342, 5001, 'fixed',     '2025-07-16 00:00:00'),
  (5343, 5001, 'published', '2025-07-16 09:00:00');

INSERT INTO vulnerability_metadata_severity (id, vulnerability_metadata_id, type, score, level, score_num) VALUES
  (5351, 5001, 'CVSS:3.1/BASE', 'AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:M/A:L', 'HIGH', 7.8),
  (5352, 5001, 'CVSS:4.0', 'CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:M/VA:L', 'MEDIUM', 6.3);

-- ========== Affected（受影响面） ==========
-- 包
INSERT INTO vulnerability_metadata_affected_package (
  id, vulnerability_metadata_id, ecosystem, name, purl, language, repository, home_page, edition, ecosystem_specific, database_specific
) VALUES (
  5401, 5001, 'PyPI', 'aiohttp', 'pkg:pypi/aiohttp', 'PYTHON', 'https://github.com/aio-libs/aiohttp', 'https://pypi.org/project/aiohttp', NULL,
  '{"module":"aiohttp","import":"aiohttp.client"}',
  '{"severity":{"CVSS:3.1":7.8}}'
);

-- 引入/修复提交
INSERT INTO vulnerability_metadata_affected_commit (id, package_id, commit_type, commit_id) VALUES
  (5411, 5401, 'INTRODUCED', 'deadbeef1'),
  (5412, 5401, 'FIXED', 'f00ba47');

-- 版本范围 + 事件
INSERT INTO vulnerability_metadata_affected_range (id, package_id, type, repo, database_specific) VALUES
  (5421, 5401, 'SEMVER', '', NULL);

INSERT INTO vulnerability_metadata_affected_range_event (id, range_id, event_type, value) VALUES
  (5431, 5421, 'introduced', '3.12.0'),
  (5432, 5421, 'fixed', '3.12.14');

-- 受影响版本枚举
INSERT INTO vulnerability_metadata_affected_version (id, package_id, version) VALUES
  (5441, 5401, '3.12.0'),
  (5442, 5401, '3.12.1'),
  (5443, 5401, '3.12.2');

-- ========== Patch / Contributors / Credits / Exploit ==========
INSERT INTO vulnerability_metadata_patch_detail (id, vulnerability_metadata_id, patch_url, issue_url, main_language, author, committer) VALUES
  (5501, 5001, 'https://github.com/aio-libs/aiohttp/commit/abcdef1234567890', 'https://github.com/aio-libs/aiohttp/issues/123', 'Python', 'Alice', 'Bob');

INSERT INTO vulnerability_metadata_patch_branch (id, patch_detail_id, name) VALUES
  (5511, 5501, 'main');

INSERT INTO vulnerability_metadata_patch_tag (id, patch_detail_id, name) VALUES
  (5521, 5501, 'v3.12.14');

INSERT INTO vulnerability_metadata_contributor (id, vulnerability_metadata_id, org, name, email, contributions) VALUES
  (5531, 5001, 'CSPioneer', 'Jeppe', 'jeppe@example.com', 'Report and PoC');

INSERT INTO vulnerability_metadata_credit (id, vulnerability_metadata_id, name, type) VALUES
  (5541, 5001, 'Security Team', 'reporter');

INSERT INTO vulnerability_metadata_credit_contact (id, credit_id, contact) VALUES
  (5551, 5541, 'mailto:sec@example.com');

INSERT INTO vulnerability_metadata_exploit_status (id, vulnerability_metadata_id, status) VALUES
  (5561, 5001, 'exploited_in_the_wild');

COMMIT;
