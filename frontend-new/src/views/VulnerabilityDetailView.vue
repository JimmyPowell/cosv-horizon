<template>
  <v-container class="my-8">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-nav mb-6">
      <v-btn
        variant="text"
        prepend-icon="mdi-arrow-left"
        class="breadcrumb-back-btn text-blue-darken-2"
        @click="goBack"
        size="small"
      >
        返回漏洞列表
      </v-btn>
      <v-breadcrumbs
        class="pa-0 breadcrumb-items"
        :items="breadcrumbItems"
        divider="/"
      >
        <template v-slot:item="{ item }">
          <v-breadcrumbs-item
            :to="item.to"
            :disabled="item.disabled"
            class="breadcrumb-item"
          >
            <v-icon v-if="item.icon" :icon="item.icon" size="small" class="mr-1" />
            {{ item.title }}
          </v-breadcrumbs-item>
        </template>
      </v-breadcrumbs>
    </div>

    <v-row>
      <v-col cols="12" md="8">
        <!-- Title & meta -->
        <div class="mb-6">
          <div class="d-flex align-center mb-2">
            <v-chip color="primary" size="small" class="mr-2" variant="flat">{{ vuln.vulnerability.identifier }}</v-chip>
            <v-chip size="small" :color="statusColor(vuln.vulnerability.status)" variant="flat">{{ vuln.vulnerability.status }}</v-chip>
          </div>
          <h1 class="text-h4 font-weight-bold mb-2">{{ vuln.vulnerability.summary }}</h1>
          <div class="text-grey-darken-2">
            <v-chip class="mr-2 mb-2" size="small" color="info" variant="tonal">{{ vuln.vulnerability.language }}</v-chip>
            <v-chip v-if="vuln.vulnerability.categoryCode" class="mr-2 mb-2" size="small" color="warning" variant="tonal">{{ vuln.vulnerability.categoryCode }}</v-chip>
            <v-chip v-for="tag in (vuln.vulnerability.tagCodes || [])" :key="tag" class="mr-2 mb-2" size="small" color="secondary" variant="tonal">{{ tag }}</v-chip>
          </div>
        </div>

        <!-- Details -->
        <v-card class="mb-6" variant="outlined">
          <v-card-title class="text-h6 font-weight-bold">概述</v-card-title>
          <v-divider />
          <v-card-text class="text-body-1 content-text markdown-content" v-html="renderedDetails"></v-card-text>
        </v-card>

        <!-- Aliases & CWE & References -->
        <v-card class="mb-6" variant="outlined">
          <v-card-title class="text-h6 font-weight-bold">标识与参考</v-card-title>
          <v-divider />
          <v-card-text>
            <div class="mb-3">
              <div class="text-subtitle-2 mb-1">别名（aliases）</div>
              <div>
                <v-chip v-for="a in (vuln.cosv.aliases || [])" :key="a" class="mr-2 mb-2" size="small" color="info" variant="tonal">{{ a }}</v-chip>
                <span v-if="!vuln.cosv.aliases || vuln.cosv.aliases.length === 0" class="text-grey text-body-2">无</span>
              </div>
            </div>
            <div class="mb-3">
              <div class="text-subtitle-2 mb-1">CWE</div>
              <div>
                <v-chip v-for="id in (vuln.cosv.cwe_ids || [])" :key="id" class="mr-2 mb-2" size="small" color="purple" variant="tonal">{{ id }}</v-chip>
                <v-chip v-for="nm in (vuln.cosv.cwe_names || [])" :key="nm" class="mr-2 mb-2" size="small" color="purple" variant="tonal">{{ nm }}</v-chip>
                <span v-if="(!vuln.cosv.cwe_ids || vuln.cosv.cwe_ids.length === 0) && (!vuln.cosv.cwe_names || vuln.cosv.cwe_names.length === 0)" class="text-grey text-body-2">无</span>
              </div>
            </div>
            <div class="mb-3">
              <div class="text-subtitle-2 mb-2">参考资料（references）</div>
              <v-list density="compact" lines="one">
                <v-list-item v-for="(r, idx) in (vuln.cosv.references || [])" :key="idx" :subtitle="r.url">
                  <template #prepend>
                    <v-chip size="x-small" class="mr-2" color="grey" variant="tonal">{{ r.type || 'link' }}</v-chip>
                  </template>
                  <template #append>
                    <v-btn icon variant="text" :href="r.url" target="_blank"><v-icon>mdi-open-in-new</v-icon></v-btn>
                  </template>
                </v-list-item>
                <div v-if="!vuln.cosv.references || vuln.cosv.references.length === 0" class="text-grey text-body-2">暂无</div>
              </v-list>
            </div>
          </v-card-text>
        </v-card>

        <!-- Timeline & Severities -->
        <v-card class="mb-6 timeline-card" variant="outlined">
          <v-card-title class="text-h6 font-weight-bold d-flex align-center">
            <v-icon class="mr-2" color="primary">mdi-timeline-clock</v-icon>
            时间线与严重性
          </v-card-title>
          <v-divider />
          <v-card-text>
            <v-row>
              <v-col cols="12" md="6">
                <div class="text-subtitle-2 mb-4 d-flex align-center">
                  <v-icon class="mr-2" size="small" color="primary">mdi-timeline</v-icon>
                  漏洞生命周期
                </div>
                <!-- Enhanced Visual Timeline -->
                <div v-if="vuln.cosv.time_line && vuln.cosv.time_line.length" class="timeline-container">
                  <div class="timeline-line"></div>
                  <div v-for="(t, idx) in vuln.cosv.time_line" :key="idx" class="timeline-item">
                    <div class="timeline-dot" :class="getTimelineColor(t.type)">
                      <v-icon size="small" color="white">{{ getTimelineIcon(t.type) }}</v-icon>
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-type">{{ getTimelineLabel(t.type) }}</div>
                      <div class="timeline-date">{{ fmtTime(t.value) }}</div>
                    </div>
                  </div>
                </div>
                <div v-else class="text-grey text-body-2 text-center py-8">
                  <v-icon size="48" color="grey-lighten-2">mdi-timeline-help</v-icon>
                  <div class="mt-2">暂无时间线数据</div>
                </div>
              </v-col>
              <v-col cols="12" md="6">
                <div class="text-subtitle-2 mb-4 d-flex align-center">
                  <v-icon class="mr-2" size="small" color="warning">mdi-shield-alert</v-icon>
                  CVSS 评分详情
                </div>
                <!-- Enhanced CVSS Table -->
                <v-card variant="outlined" class="cvss-table-card">
                  <v-table density="comfortable" class="cvss-table">
                    <thead>
                      <tr class="cvss-header">
                        <th class="text-left font-weight-bold">评分类型</th>
                        <th class="text-center font-weight-bold">数值</th>
                        <th class="text-center font-weight-bold">等级</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="(s, idx) in (vuln.cosv.severity || [])" :key="idx" class="cvss-row">
                        <td class="cvss-type">
                          <v-chip size="small" color="info" variant="tonal">{{ s.type || '-' }}</v-chip>
                        </td>
                        <td class="text-center cvss-score">
                          <span class="score-number">{{ s.score_num ?? '-' }}</span>
                        </td>
                        <td class="text-center cvss-level">
                          <v-chip 
                            size="small" 
                            :color="getSeverityChipColor(s.score_num)" 
                            variant="flat"
                          >
                            {{ s.level || '-' }}
                          </v-chip>
                        </td>
                      </tr>
                      <tr v-if="!vuln.cosv.severity || vuln.cosv.severity.length === 0">
                        <td colspan="3" class="text-center text-grey py-6">
                          <v-icon size="32" color="grey-lighten-2">mdi-shield-off</v-icon>
                          <div class="mt-2">暂无评分数据</div>
                        </td>
                      </tr>
                    </tbody>
                  </v-table>
                </v-card>
              </v-col>
            </v-row>
          </v-card-text>
        </v-card>

        <!-- Affected packages (mock) -->
        <v-card class="mb-6" variant="outlined">
          <v-card-title class="text-h6 font-weight-bold">受影响范围（Affected - 示例）</v-card-title>
          <v-divider />
          <v-card-text>
            <div v-for="(a, idx) in (vuln.cosv.affected || [])" :key="idx" class="mb-4">
              <div class="mb-2">
                <v-chip size="small" class="mr-2" color="green-lighten-5" text-color="green-darken-2">{{ a.package?.ecosystem || 'ECOSYSTEM' }}</v-chip>
                <strong>{{ a.package?.name }}</strong>
                <span class="text-grey ml-2">{{ a.package?.purl }}</span>
              </div>
              <div class="text-body-2 mb-1">仓库：
                <a v-if="a.package?.repository" :href="a.package.repository" target="_blank">{{ a.package.repository }}</a>
                <span v-else>未知</span>
              </div>
              <div class="text-body-2 mb-2">受影响版本：
                <v-chip v-for="v in (a.versions || [])" :key="v" class="mr-1 mb-1" size="x-small" color="grey-lighten-4" text-color="grey-darken-3">{{ v }}</v-chip>
                <span v-if="!a.versions || a.versions.length === 0" class="text-grey">未枚举</span>
              </div>
              <div class="text-body-2">范围：
                <div v-for="(r, i2) in (a.ranges || [])" :key="i2" class="ml-2 mb-1">
                  <span class="mr-2">[{{ r.type }}]</span>
                  <span v-if="r.repo" class="mr-2">repo: {{ r.repo }}</span>
                  <span>events:
                    <span v-for="(ev, j) in (r.events || [])" :key="j" class="mr-2">{{ oneKey(ev) }}</span>
                  </span>
                </div>
                <span v-if="!a.ranges || a.ranges.length === 0" class="text-grey">未提供</span>
              </div>
            </div>
            <div v-if="!vuln.cosv.affected || vuln.cosv.affected.length === 0" class="text-grey text-body-2">暂无示例数据</div>
          </v-card-text>
        </v-card>

        <!-- Patch / Contributors / Credits -->
        <v-card class="mb-6 patch-card" variant="outlined">
          <v-card-title class="text-h6 font-weight-bold d-flex align-center">
            <v-icon class="mr-2" color="success">mdi-source-commit</v-icon>
            修复与贡献
          </v-card-title>
          <v-divider />
          <v-card-text>
            <div class="mb-4">
              <div class="text-subtitle-2 mb-3 d-flex align-center">
                <v-icon class="mr-2" size="small" color="success">mdi-file-code</v-icon>
                补丁信息
              </div>
              <v-list density="compact" v-if="vuln.cosv.patch_details && vuln.cosv.patch_details.length" class="patch-list">
                <v-list-item v-for="(p, idx) in vuln.cosv.patch_details" :key="idx" class="patch-item">
                  <template v-slot:prepend>
                    <v-icon color="success">mdi-source-commit</v-icon>
                  </template>
                  <v-list-item-title class="patch-links">
                    <a v-if="p.patch_url" :href="p.patch_url" target="_blank" class="patch-link">
                      <v-icon size="small" class="mr-1">mdi-link</v-icon>
                      补丁链接
                    </a>
                    <span v-else class="text-grey">补丁链接不可用</span>
                    <span v-if="p.issue_url" class="ml-3">
                      <a :href="p.issue_url" target="_blank" class="issue-link">
                        <v-icon size="small" class="mr-1">mdi-bug</v-icon>
                        相关Issue
                      </a>
                    </span>
                  </v-list-item-title>
                  <v-list-item-subtitle class="patch-meta">
                    <v-chip v-if="p.main_language" size="x-small" class="mr-1" color="blue" variant="tonal">{{ p.main_language }}</v-chip>
                    <span v-if="p.author" class="author-info">作者: {{ p.author }}</span>
                    <span v-if="p.committer" class="committer-info ml-2">提交者: {{ p.committer }}</span>
                  </v-list-item-subtitle>
                </v-list-item>
              </v-list>
              <div v-else class="text-center py-6 text-grey">
                <v-icon size="48" color="grey-lighten-2">mdi-source-commit-local</v-icon>
                <div class="mt-2">暂无补丁信息</div>
              </div>
            </div>

            <div class="mb-4">
              <div class="text-subtitle-2 mb-3 d-flex align-center">
                <v-icon class="mr-2" size="small" color="purple">mdi-account-group</v-icon>
                贡献者
              </div>
              <div v-if="vuln.cosv.contributors && vuln.cosv.contributors.length" class="contributors-grid">
                <v-chip 
                  v-for="(c, idx) in vuln.cosv.contributors" 
                  :key="idx" 
                  class="contributor-chip" 
                  size="small" 
                  color="purple" 
                  variant="tonal"
                  prepend-icon="mdi-account"
                >
                  {{ [c.org, c.name].filter(Boolean).join(' / ') || c.name }}
                </v-chip>
              </div>
              <div v-else class="text-center py-4 text-grey">
                <v-icon size="32" color="grey-lighten-2">mdi-account-off</v-icon>
                <div class="mt-2">暂无贡献者信息</div>
              </div>
            </div>

            <div>
              <div class="text-subtitle-2 mb-3 d-flex align-center">
                <v-icon class="mr-2" size="small" color="orange">mdi-star</v-icon>
                致谢名单
              </div>
              <div v-if="vuln.cosv.credits && vuln.cosv.credits.length" class="credits-list">
                <div v-for="(cr, idx) in vuln.cosv.credits" :key="idx" class="credit-item">
                  <div class="credit-header">
                    <v-icon class="mr-2" color="orange">mdi-account-star</v-icon>
                    <strong>{{ cr.name }}</strong>
                    <v-chip v-if="cr.type" size="x-small" class="ml-2" color="orange" variant="tonal">{{ cr.type }}</v-chip>
                  </div>
                  <div v-if="cr.contact && cr.contact.length" class="credit-contacts mt-1">
                    <v-chip 
                      v-for="ct in cr.contact" 
                      :key="ct" 
                      size="x-small" 
                      class="mr-1" 
                      color="grey" 
                      variant="outlined"
                      prepend-icon="mdi-email"
                    >
                      {{ ct }}
                    </v-chip>
                  </div>
                </div>
              </div>
              <div v-else class="text-center py-4 text-grey">
                <v-icon size="32" color="grey-lighten-2">mdi-star-off</v-icon>
                <div class="mt-2">暂无致谢信息</div>
              </div>
            </div>
          </v-card-text>
        </v-card>
      </v-col>

      <v-col cols="12" md="4">
        <!-- Severity summary -->
        <v-card class="pa-6 mb-6 severity-card">
          <div class="d-flex align-center mb-3">
            <v-icon class="mr-2" color="warning">mdi-shield-alert</v-icon>
            <div class="text-subtitle-1 font-weight-bold">严重性评分</div>
          </div>
          <div class="severity-display">
            <div class="severity-circle" :class="getSeverityCircleClass(vuln.vulnerability.severityNum)">
              <div class="severity-number">{{ vuln.vulnerability.severityNum }}</div>
            </div>
            <v-chip 
              class="mt-3" 
              :color="severityColor(vuln.vulnerability.severityNum)" 
              variant="flat"
              size="large"
            >
              {{ severityLevel(vuln.vulnerability.severityNum) }}
            </v-chip>
          </div>
        </v-card>

        <!-- Meta info -->
        <v-card class="pa-6 meta-info-card">
          <div class="d-flex align-center mb-4">
            <v-icon class="mr-2" color="info">mdi-information</v-icon>
            <div class="text-subtitle-1 font-weight-bold">基本信息</div>
          </div>
          <div class="meta-info-grid">
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-account</v-icon>
                提交者
              </div>
              <div class="meta-value">{{ vuln.vulnerability.submitterType === 'ORG' ? '组织' : '个人' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-code-json</v-icon>
                Schema 版本
              </div>
              <div class="meta-value">{{ vuln.vulnerability.schemaVersion || '-' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-check-circle</v-icon>
                确认类型
              </div>
              <div class="meta-value">{{ vuln.vulnerability.confirmedType || '-' }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-calendar-plus</v-icon>
                提交时间
              </div>
              <div class="meta-value">{{ fmtTime(vuln.vulnerability.submitted) }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-calendar-edit</v-icon>
                更新时间
              </div>
              <div class="meta-value">{{ fmtTime(vuln.vulnerability.modified) }}</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-calendar-check</v-icon>
                发布时间
              </div>
              <div class="meta-value">{{ fmtTime(vuln.vulnerability.published) }}</div>
            </div>
            <div v-if="vuln.vulnerability.withdrawn" class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-calendar-remove</v-icon>
                撤回时间
              </div>
              <div class="meta-value">{{ fmtTime(vuln.vulnerability.withdrawn) }}</div>
            </div>
            <div v-if="vuln.cosv.exploit_status && vuln.cosv.exploit_status.length" class="meta-item">
              <div class="meta-label">
                <v-icon size="small" class="mr-2" color="grey">mdi-security</v-icon>
                利用状态
              </div>
              <div class="meta-value">
                <v-chip 
                  v-for="s in vuln.cosv.exploit_status" 
                  :key="s" 
                  class="mr-1 mb-1" 
                  size="x-small" 
                  color="error" 
                  variant="tonal"
                >
                  {{ s }}
                </v-chip>
              </div>
            </div>
          </div>
        </v-card>
      </v-col>
    </v-row>

    <!-- Comments -->
    <v-row>
      <v-col cols="12">
        <vuln-comments v-if="vuln.vulnerability.uuid" :vuln-uuid="vuln.vulnerability.uuid" />
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup>
import { reactive, computed, ref, onMounted } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import vulnerabilityApi from '@/api/vulnerability';
import VulnComments from '@/components/VulnComments.vue';
import { marked } from 'marked';
import DOMPurify from 'dompurify';

const route = useRoute();
const router = useRouter();
const loading = ref(true);
const error = ref('');

// 配置 marked
marked.setOptions({
  breaks: true,        // 支持 GitHub 风格的换行
  gfm: true,          // 启用 GitHub Flavored Markdown
  headerIds: true,    // 为标题生成 ID
  mangle: false,      // 不混淆邮箱地址
});

// 渲染 Markdown 格式的详情
const renderedDetails = computed(() => {
  if (!vuln.vulnerability.details) return '<p class="text-grey">暂无详情</p>';

  try {
    // 1. Markdown → HTML
    const rawHtml = marked.parse(vuln.vulnerability.details);

    // 2. XSS 防护
    const cleanHtml = DOMPurify.sanitize(rawHtml, {
      ALLOWED_TAGS: [
        'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'p', 'br', 'hr',
        'strong', 'em', 'del', 'code', 'pre',
        'ul', 'ol', 'li',
        'a', 'img',
        'blockquote',
        'table', 'thead', 'tbody', 'tr', 'th', 'td'
      ],
      ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'target', 'rel']
    });

    return cleanHtml;
  } catch (err) {
    console.error('Markdown rendering error:', err);
    // 如果渲染失败，回退到纯文本显示
    return `<p>${vuln.vulnerability.details}</p>`;
  }
});

// Safe default shape to avoid undefined access in template
const vuln = reactive({
  vulnerability: {
    uuid: '',
    identifier: '-',
    summary: '-',
    details: '',
    severityNum: 0,
    language: '-',
    status: '-',
    schemaVersion: '',
    confirmedType: '',
    categoryCode: '',
    tagCodes: [],
    submitted: null,
    modified: null,
    published: null,
    withdrawn: null,
    submitterType: 'USER',
  },
  cosv: {
    id: '',
    schema_version: '',
    summary: '',
    details: '',
    aliases: [],
    related: [],
    references: [],
    cwe_ids: [],
    cwe_names: [],
    time_line: [],
    severity: [],
    affected: [],
    patch_details: [],
    contributors: [],
    credits: [],
    exploit_status: [],
  }
});

function normalizeVuln(res) {
  const v = res?.data?.data?.vulnerability || {};
  const c = res?.data?.data?.cosv || {};
  const arr = (x) => (Array.isArray(x) ? x : []);
  vuln.vulnerability = {
    uuid: v.uuid || '',
    identifier: v.identifier || '-',
    summary: v.summary || '-',
    details: v.details || '',
    severityNum: v.severityNum ?? 0,
    language: v.language || '-',
    status: v.status || '-',
    schemaVersion: v.schemaVersion || '',
    confirmedType: v.confirmedType || '',
    categoryCode: v.categoryCode || '',
    tagCodes: arr(v.tagCodes),
    submitted: v.submitted || null,
    modified: v.modified || null,
    published: v.published || null,
    withdrawn: v.withdrawn || null,
    submitterType: v.submitterType || 'USER',
  };
  vuln.cosv = {
    id: c.id || vuln.vulnerability.identifier,
    schema_version: c.schema_version || vuln.vulnerability.schemaVersion,
    summary: c.summary || vuln.vulnerability.summary,
    details: c.details || '',
    aliases: arr(c.aliases),
    related: arr(c.related),
    references: arr(c.references),
    cwe_ids: arr(c.cwe_ids),
    cwe_names: arr(c.cwe_names),
    time_line: arr(c.time_line),
    severity: arr(c.severity),
    affected: arr(c.affected),
    patch_details: arr(c.patch_details),
    contributors: arr(c.contributors),
    credits: arr(c.credits),
    exploit_status: arr(c.exploit_status),
  };
}

const useMock = computed(() => {
  const v = route.query?.mock;
  return v === '1' || v === 'true';
});

async function fetchDetail() {
  if (useMock.value) { setMockData(); return; }
  loading.value = true; error.value = '';
  try {
    const uuid = String(route.params.id || '').trim();
    const res = await vulnerabilityApi.getByUuid(uuid);
    normalizeVuln(res);
  } catch (e) {
    error.value = e?.response?.data?.message || e?.message || '加载失败';
  } finally {
    loading.value = false;
  }
}

onMounted(fetchDetail);

function setMockData() {
  loading.value = false; error.value = '';
  vuln.vulnerability = {
    uuid: 'vm-uuid-123',
    identifier: 'COSV-2025-000123',
    summary: 'HTTP 请求走私',
    details: '此软件包的受影响版本容易受到HTTP请求走私的影响，原因是请求预告片部分解析不正确。攻击者可以通过精心构造的HTTP请求来绕过某些防护。\n\n注意：仅当安装了纯Python版本或禁用了扩展时该漏洞可被利用。',
    severityNum: 6.3,
    language: 'PYTHON',
    status: 'ACTIVE',
    schemaVersion: '1.0.0',
    confirmedType: 'manual_confirmed',
    categoryCode: 'HTTP_SMUGGLING',
    tagCodes: ['WEB', 'CWE-444'],
    submitted: '2025-07-15T12:00:00Z',
    modified: '2025-07-16T09:00:00Z',
    published: '2025-07-16T09:00:00Z',
    withdrawn: null,
    submitterType: 'USER',
  };
  vuln.cosv = {
    id: 'COSV-2025-000123',
    schema_version: '1.0.0',
    summary: 'HTTP 请求走私',
    details: 'mock',
    aliases: ['CVE-2025-53643'],
    related: [],
    references: [
      { type: 'advisory', url: 'https://nvd.nist.gov/vuln/detail/CVE-2025-53643' },
      { type: 'patch', url: 'https://github.com/aio-libs/aiohttp/commit/xxxxx' },
    ],
    cwe_ids: ['CWE-444'],
    cwe_names: ['HTTP Request Smuggling'],
    time_line: [
      { type: 'disclosed', value: '2025-07-15T00:00:00Z' },
      { type: 'fixed', value: '2025-07-16T00:00:00Z' },
    ],
    severity: [
      { type: 'CVSS:3.1/BASE', score: 'AV:N/AC:L/...', level: 'HIGH', score_num: 7.5 },
      { type: 'CVSS:4.0', score: '.../...', level: 'MEDIUM', score_num: 6.3 },
    ],
    affected: [
      {
        package: {
          ecosystem: 'PyPI', name: 'aiohttp', purl: 'pkg:pypi/aiohttp', language: 'PYTHON',
          repository: 'https://github.com/aio-libs/aiohttp', home_page: 'https://pypi.org/project/aiohttp', edition: null,
          introduced_commits: [], fixed_commits: []
        },
        ranges: [ { type: 'SEMVER', repo: '', events: [ { introduced: '3.12.0' }, { fixed: '3.12.14' } ] } ],
        versions: ['3.12.0', '3.12.1', '3.12.2']
      }
    ],
    patch_details: [
      { patch_url: 'https://github.com/aio-libs/aiohttp/commit/xxxxx', issue_url: 'https://github.com/aio-libs/aiohttp/issues/123', main_language: 'Python', author: 'Alice', committer: 'Bob', branches: ['main'], tags: ['v3.12.14'] }
    ],
    contributors: [ { org: 'CSPioneer', name: 'Jeppe', email: 'jeppe@example.com', contributions: 'Report and PoC' } ],
    credits: [ { name: 'Security Team', type: 'reporter', contact: ['mailto:sec@example.com'] } ],
    exploit_status: ['exploited_in_the_wild'],
  };
}

function paragraphs(text) {
  if (!text) return [];
  return String(text).split(/\n+/).filter(Boolean);
}

function fmtTime(s) {
  if (!s) return '-';
  try { return new Date(s).toLocaleString(); } catch { return s; }
}

function oneKey(obj) {
  if (!obj || typeof obj !== 'object') return '';
  const k = Object.keys(obj)[0];
  return k ? `${k}: ${obj[k]}` : '';
}

function severityColor(score) {
  const s = Number(score);
  if (s >= 9) return 'error';
  if (s >= 7) return 'warning';
  if (s >= 4) return 'amber';
  return 'grey';
}
function severityLevel(score) {
  const s = Number(score);
  if (s >= 9) return '严重';
  if (s >= 7) return '较高';
  if (s >= 4) return '中等';
  return '较低';
}
function statusColor(st) {
  switch (st) {
    case 'ACTIVE': return 'success';
    case 'PENDING': return 'warning';
    case 'REJECTED': return 'error';
    case 'FIXED': return 'info';
    default: return 'grey';
  }
}

// New helper functions for enhanced UI
function getTimelineColor(type) {
  switch (type) {
    case 'disclosed': return 'timeline-disclosed';
    case 'fixed': return 'timeline-fixed';
    case 'published': return 'timeline-published';
    default: return 'timeline-default';
  }
}

function getTimelineIcon(type) {
  switch (type) {
    case 'disclosed': return 'mdi-eye';
    case 'fixed': return 'mdi-check-circle';
    case 'published': return 'mdi-publish';
    default: return 'mdi-circle';
  }
}

function getTimelineLabel(type) {
  switch (type) {
    case 'disclosed': return '漏洞披露';
    case 'fixed': return '修复完成';
    case 'published': return '正式发布';
    default: return type;
  }
}

function getSeverityChipColor(score) {
  const s = Number(score);
  if (s >= 9) return 'error';
  if (s >= 7) return 'warning';
  if (s >= 4) return 'amber';
  return 'success';
}

function getSeverityCircleClass(score) {
  const s = Number(score);
  if (s >= 9) return 'severity-critical';
  if (s >= 7) return 'severity-high';
  if (s >= 4) return 'severity-medium';
  return 'severity-low';
}

// Router and navigation

// Breadcrumb navigation data
const breadcrumbItems = computed(() => [
  {
    title: '漏洞列表',
    to: '/dashboard',
    disabled: false,
    icon: 'mdi-shield-search'
  },
  {
    title: vuln.vulnerability.summary,
    to: null,
    disabled: true,
    icon: 'mdi-bug'
  }
]);

// Go back to vulnerability list
function goBack() {
  router.push('/dashboard');
}
</script>

<style scoped>
/* Breadcrumb Navigation Styles */
.breadcrumb-nav {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 0;
  border-bottom: 1px solid #e2e8f0;
  margin-bottom: 24px;
}

.breadcrumb-back-btn {
  font-weight: 500;
  text-transform: none;
  letter-spacing: normal;
  padding: 8px 12px;
  min-width: auto;
}

.breadcrumb-back-btn:hover {
  background-color: rgba(25, 118, 210, 0.04);
}

.breadcrumb-items {
  flex: 1;
}

.breadcrumb-item {
  font-size: 14px;
  color: #6b7280;
}

.breadcrumb-item:not(.v-breadcrumbs-item--disabled) {
  color: #1976d2;
}

.breadcrumb-item:not(.v-breadcrumbs-item--disabled):hover {
  color: #1565c0;
}

.card-heavy { 
  border: 1px solid #e2e8f0; 
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03) !important; 
}

.content-text p { 
  line-height: 1.8; 
}

a { 
  color: #3b82f6; 
  text-decoration: none; 
  font-weight: 500; 
}

a:hover { 
  text-decoration: underline; 
}

/* Enhanced Timeline Styles */
.timeline-card {
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.timeline-container {
  position: relative;
  padding: 20px 0;
}

.timeline-line {
  position: absolute;
  left: 20px;
  top: 30px;
  bottom: 30px;
  width: 2px;
  background: linear-gradient(to bottom, #3b82f6, #10b981);
  border-radius: 1px;
}

.timeline-item {
  position: relative;
  display: flex;
  align-items: center;
  margin-bottom: 24px;
  padding-left: 60px;
}

.timeline-dot {
  position: absolute;
  left: 8px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.timeline-disclosed { background: #3b82f6; }
.timeline-fixed { background: #10b981; }
.timeline-published { background: #8b5cf6; }
.timeline-default { background: #6b7280; }

.timeline-content {
  flex: 1;
}

.timeline-type {
  font-weight: 600;
  color: #1f2937;
  font-size: 14px;
}

.timeline-date {
  color: #6b7280;
  font-size: 12px;
  margin-top: 2px;
}

/* Enhanced CVSS Table Styles */
.cvss-table-card {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
}

.cvss-table {
  border-radius: 8px;
}

.cvss-header th {
  background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
  color: #374151;
  font-weight: 600;
  padding: 12px 16px;
  border-bottom: 2px solid #d1d5db;
}

.cvss-row {
  transition: background-color 0.2s ease;
}

.cvss-row:hover {
  background-color: #f9fafb;
}

.cvss-type {
  padding: 12px 16px;
}

.cvss-score {
  padding: 12px 16px;
}

.score-number {
  font-weight: 600;
  font-size: 16px;
  color: #1f2937;
}

.cvss-level {
  padding: 12px 16px;
}

/* Enhanced Severity Card */
.severity-card {
  background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%);
  border: 1px solid #f59e0b;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.1);
}

.severity-display {
  text-align: center;
}

.severity-circle {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  position: relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.severity-critical {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.severity-high {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

.severity-medium {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
}

.severity-low {
  background: linear-gradient(135deg, #10b981, #059669);
}

.severity-number {
  color: white;
  font-size: 24px;
  font-weight: 700;
}

/* Enhanced Meta Info Card */
.meta-info-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
  border: 1px solid #0ea5e9;
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.1);
}

.meta-info-grid {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.meta-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.meta-label {
  display: flex;
  align-items: center;
  font-size: 13px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.meta-value {
  font-size: 14px;
  color: #1f2937;
  font-weight: 500;
  padding-left: 24px;
}

/* Enhanced Patch Card */
.patch-card {
  background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
  border: 1px solid #10b981;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
}

.patch-list {
  background: transparent;
}

.patch-item {
  border: 1px solid #d1fae5;
  border-radius: 8px;
  margin-bottom: 12px;
  background: #f0fdf4;
  transition: all 0.2s ease;
}

.patch-item:hover {
  background: #ecfdf5;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
}

.patch-links {
  display: flex;
  align-items: center;
  gap: 16px;
}

.patch-link, .issue-link {
  display: flex;
  align-items: center;
  color: #059669;
  font-weight: 500;
}

.patch-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
}

.author-info, .committer-info {
  font-size: 12px;
  color: #6b7280;
}

.contributors-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.contributor-chip {
  margin: 2px;
}

.credits-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.credit-item {
  padding: 12px;
  border: 1px solid #fed7aa;
  border-radius: 8px;
  background: #fff7ed;
}

.credit-header {
  display: flex;
  align-items: center;
}

.credit-contacts {
  margin-left: 32px;
}

/* Markdown 内容样式 */
.markdown-content {
  line-height: 1.6;
  color: #24292f;
}

.markdown-content :deep(h1),
.markdown-content :deep(h2),
.markdown-content :deep(h3),
.markdown-content :deep(h4),
.markdown-content :deep(h5),
.markdown-content :deep(h6) {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25;
}

.markdown-content :deep(h1) {
  font-size: 2em;
  border-bottom: 1px solid #d0d7de;
  padding-bottom: 0.3em;
}

.markdown-content :deep(h2) {
  font-size: 1.5em;
  border-bottom: 1px solid #d0d7de;
  padding-bottom: 0.3em;
}

.markdown-content :deep(h3) {
  font-size: 1.25em;
}

.markdown-content :deep(h4) {
  font-size: 1em;
}

.markdown-content :deep(h5) {
  font-size: 0.875em;
}

.markdown-content :deep(h6) {
  font-size: 0.85em;
  color: #57606a;
}

.markdown-content :deep(p) {
  margin-bottom: 16px;
}

.markdown-content :deep(code) {
  background-color: rgba(175, 184, 193, 0.2);
  padding: 0.2em 0.4em;
  border-radius: 6px;
  font-size: 85%;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

.markdown-content :deep(pre) {
  background-color: #f6f8fa;
  padding: 16px;
  border-radius: 6px;
  overflow-x: auto;
  margin-bottom: 16px;
}

.markdown-content :deep(pre code) {
  background-color: transparent;
  padding: 0;
}

.markdown-content :deep(ul),
.markdown-content :deep(ol) {
  margin-bottom: 16px;
  padding-left: 2em;
}

.markdown-content :deep(li) {
  margin-bottom: 4px;
}

.markdown-content :deep(a) {
  color: #0969da;
  text-decoration: none;
}

.markdown-content :deep(a:hover) {
  text-decoration: underline;
}

.markdown-content :deep(blockquote) {
  border-left: 4px solid #d0d7de;
  padding-left: 16px;
  color: #57606a;
  margin-bottom: 16px;
}

.markdown-content :deep(table) {
  border-collapse: collapse;
  width: 100%;
  margin-bottom: 16px;
}

.markdown-content :deep(th),
.markdown-content :deep(td) {
  border: 1px solid #d0d7de;
  padding: 8px 12px;
}

.markdown-content :deep(th) {
  background-color: #f6f8fa;
  font-weight: 600;
}

.markdown-content :deep(img) {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
}

.markdown-content :deep(hr) {
  height: 0.25em;
  padding: 0;
  margin: 24px 0;
  background-color: #d0d7de;
  border: 0;
}

.markdown-content :deep(strong) {
  font-weight: 600;
}

.markdown-content :deep(em) {
  font-style: italic;
}

.markdown-content :deep(del) {
  text-decoration: line-through;
}
</style>
