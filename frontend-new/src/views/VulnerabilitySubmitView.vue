<template>
  <v-container class="my-8">
    <!-- Back Button -->
    <v-btn
      variant="text"
      prepend-icon="mdi-arrow-left"
      class="mb-4 text-blue-darken-2"
      @click="goBack"
      size="small"
    >
      返回
    </v-btn>

    <div class="d-flex align-center mb-6">
      <v-icon size="26" color="primary" class="mr-2">mdi-bug-plus-outline</v-icon>
      <h1 class="text-h4 font-weight-bold">提交漏洞</h1>
    </div>

    <!-- Tabs (light, transparent) -->
    <v-sheet elevation="0" class="mb-2">
      <v-tabs v-model="activeTab" bg-color="transparent" slider-color="primary">
        <v-tab value="form">
          <v-icon start>mdi-form-textbox</v-icon>
          表单提交
        </v-tab>
        <v-tab value="file">
          <v-icon start>mdi-file-upload</v-icon>
          文件上传
        </v-tab>
        <v-tab value="history">
          <v-icon start>mdi-history</v-icon>
          我的提交
        </v-tab>
      </v-tabs>

      <v-window v-model="activeTab" class="mt-4">
        <!-- Form Submit Tab -->
        <v-window-item value="form">
          <div class="pa-6">
            <!-- Identity Selection (Flat design with background) -->
            <div class="mb-6 pa-4 rounded" style="background-color: #f5f5f5;">
              <div class="d-flex align-center mb-3">
                <v-icon class="mr-2" color="primary">mdi-account-switch</v-icon>
                <span class="text-subtitle-1 font-weight-bold">选择提交身份</span>
              </div>
              <v-radio-group v-model="submitter" inline>
                <v-radio :value="'PERSON'" label="以个人身份提交" />
                <v-radio :value="'ORG'" :label="orgOptionLabel" :disabled="!hasAdminOrgs" />
              </v-radio-group>

              <v-expand-transition>
                <div v-if="submitter === 'ORG'">
                  <v-select
                    v-model="organizationUuid"
                    :items="adminOrgItems"
                    item-title="name"
                    item-value="uuid"
                    label="选择组织（仅管理员可代表组织提交）"
                    :disabled="!hasAdminOrgs"
                    variant="outlined"
                    class="mt-4"
                  />
                  <v-alert v-if="!hasAdminOrgs" type="warning" variant="tonal" class="mt-3">
                    你当前没有管理员权限的组织，无法以组织身份提交。
                  </v-alert>
                </div>
              </v-expand-transition>
            </div>

            <!-- Form Content -->
            <FormSubmitContent
              :submitter="submitter"
              :organization-uuid="organizationUuid"
              @success="handleSuccess"
            />
          </div>
        </v-window-item>

        <!-- File Upload Tab -->
        <v-window-item value="file">
          <div class="pa-6">
            <!-- Identity Selection (Flat design with background) -->
            <div class="mb-6 pa-4 rounded" style="background-color: #f5f5f5;">
              <div class="d-flex align-center mb-3">
                <v-icon class="mr-2" color="primary">mdi-account-switch</v-icon>
                <span class="text-subtitle-1 font-weight-bold">选择提交身份</span>
              </div>
              <v-radio-group v-model="submitter" inline>
                <v-radio :value="'PERSON'" label="以个人身份提交" />
                <v-radio :value="'ORG'" :label="orgOptionLabel" :disabled="!hasAdminOrgs" />
              </v-radio-group>

              <v-expand-transition>
                <div v-if="submitter === 'ORG'">
                  <v-select
                    v-model="organizationUuid"
                    :items="adminOrgItems"
                    item-title="name"
                    item-value="uuid"
                    label="选择组织（仅管理员可代表组织提交）"
                    :disabled="!hasAdminOrgs"
                    variant="outlined"
                    class="mt-4"
                  />
                  <v-alert v-if="!hasAdminOrgs" type="warning" variant="tonal" class="mt-3">
                    你当前没有管理员权限的组织，无法以组织身份提交。
                  </v-alert>
                </div>
              </v-expand-transition>
            </div>

            <!-- File Upload Content -->
            <FileUploadContent
              :submitter="submitter"
              :organization-uuid="organizationUuid"
              @success="handleSuccess"
            />
          </div>
        </v-window-item>

        <!-- History Tab -->
        <v-window-item value="history">
          <div class="pa-6">
            <HistorySubmitContent />
          </div>
        </v-window-item>
      </v-window>
    </v-sheet>
  </v-container>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import organizationApi from '@/api/organization';
import FormSubmitContent from '@/components/submit/FormSubmitContent.vue';
import FileUploadContent from '@/components/submit/FileUploadContent.vue';
import HistorySubmitContent from '@/components/submit/HistorySubmitContent.vue';

const router = useRouter();

// Active tab: 'form' | 'file' | 'history'
const activeTab = ref('form');

// Identity
const submitter = ref('PERSON'); // 'PERSON' | 'ORG'
const organizationUuid = ref(null);
const adminOrgItems = ref([]);
const hasAdminOrgs = computed(() => (adminOrgItems.value?.length || 0) > 0);
const orgOptionLabel = computed(() => hasAdminOrgs.value ? '以组织身份提交' : '以组织身份提交（需要组织管理员）');

// Load admin organizations
async function loadAdminOrgs() {
  try {
    const res = await organizationApi.listMine();
    const items = res?.data?.data?.items || [];
    // 后端返回的结构为扁平：{ uuid, name, ..., role }
    // 兼容旧结构（嵌套 organization）与当前扁平结构
    adminOrgItems.value = items
      .map(it => {
        const role = it?.role || it?.organization?.role;
        const uuid = it?.organization?.uuid ?? it?.uuid;
        const name = it?.organization?.name ?? it?.name;
        if (role === 'ADMIN' && uuid && name) return { uuid, name };
        return null;
      })
      .filter(Boolean);
  } catch (e) {
    console.error('Failed to load organizations:', e);
    adminOrgItems.value = [];
  }
}

function goBack() {
  router.back();
}

function handleSuccess() {
  // Navigate to dashboard or vulnerability list
  router.push('/dashboard');
}

onMounted(() => {
  loadAdminOrgs();
});
</script>

<style scoped>
/* No custom styles needed for tabs */
</style>
