package tech.cspioneer.backend.mapper;

import org.apache.ibatis.annotations.*;
import tech.cspioneer.backend.entity.VulnerabilityComment;
import tech.cspioneer.backend.dto.CommentView;

import java.util.List;

@Mapper
public interface VulnerabilityCommentMapper {

    @Insert("INSERT INTO vulnerability_comment(uuid, vulnerability_metadata_id, user_id, parent_id, content, is_edited, status) VALUES(#{uuid}, #{vulnerabilityMetadataId}, #{userId}, #{parentId}, #{content}, COALESCE(#{isEdited}, 0), COALESCE(#{status}, 'ACTIVE'))")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(VulnerabilityComment c);

    @Select("SELECT id, uuid, vulnerability_metadata_id AS vulnerabilityMetadataId, user_id AS userId, parent_id AS parentId, content, is_edited AS isEdited, status, create_time AS createTime, update_time AS updateTime FROM vulnerability_comment WHERE uuid = #{uuid} LIMIT 1")
    VulnerabilityComment findByUuid(@Param("uuid") String uuid);

    @Update("UPDATE vulnerability_comment SET status = 'DELETED' WHERE uuid = #{uuid} AND user_id = #{userId}")
    int softDeleteByUuidAndUser(@Param("uuid") String uuid, @Param("userId") Long userId);

    @Update("UPDATE vulnerability_comment SET status = #{status} WHERE uuid = #{uuid}")
    int adminUpdateStatusByUuid(@Param("uuid") String uuid, @Param("status") String status);

    @Select({
            "<script>",
            "SELECT ",
            "  c.uuid AS commentUuid,",
            "  c.content AS content,",
            "  c.is_edited AS isEdited,",
            "  c.status AS status,",
            "  c.create_time AS createTime,",
            "  u.uuid AS userUuid,",
            "  u.name AS userName,",
            "  u.avatar AS userAvatar",
            "FROM vulnerability_comment c JOIN `user` u ON u.id = c.user_id",
            "WHERE c.vulnerability_metadata_id = #{vulnId}",
            "<if test='status != null'> AND c.status = #{status} </if>",
            "ORDER BY c.create_time ASC",
            "LIMIT #{limit} OFFSET #{offset}",
            "</script>"
    })
    List<CommentView> listByVulnerabilityId(@Param("vulnId") Long vulnId,
                                            @Param("status") String status,
                                            @Param("limit") int limit,
                                            @Param("offset") int offset);

    @Select({
            "<script>",
            "SELECT COUNT(1) FROM vulnerability_comment c",
            "WHERE c.vulnerability_metadata_id = #{vulnId}",
            "<if test='status != null'> AND c.status = #{status} </if>",
            "</script>"
    })
    long countByVulnerabilityId(@Param("vulnId") Long vulnId,
                                @Param("status") String status);

    @Select({
            "SELECT ",
            "  c.uuid AS commentUuid, c.content AS content, c.is_edited AS isEdited, c.status AS status, c.create_time AS createTime,",
            "  u.uuid AS userUuid, u.name AS userName, u.avatar AS userAvatar",
            "FROM vulnerability_comment c JOIN `user` u ON u.id = c.user_id",
            "WHERE c.uuid = #{uuid} LIMIT 1"
    })
    CommentView findViewByUuid(@Param("uuid") String uuid);
}

