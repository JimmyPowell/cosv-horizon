-- COSV Horizon 完整漏洞测试数据（自动获取自增ID，避免主键冲突）
-- 适用数据库：MySQL 8.x（或兼容）

START TRANSACTION;

-- 统一使用变量保存 UUID/唯一键，便于后续引用
SET @U1 := '00000000-0000-4000-8000-000000000001'; -- tester
SET @U2 := '00000000-0000-4000-8000-000000000002'; -- admin2 (reviewer)
SET @ORG := '00000000-0000-4000-8000-000000000101';
SET @LNK := '00000000-0000-4000-8000-000000000301';
SET @CAT := '00000000-0000-4000-8000-000000000401';
SET @TAG1 := '00000000-0000-4000-8000-000000000701'; -- WEB
SET @TAG2 := '00000000-0000-4000-8000-000000000702'; -- CWE-444
SET @TAG3 := '00000000-0000-4000-8000-000000000703'; -- RCE
SET @CF := '00000000-0000-4000-8000-000000000601';
SET @VM := '00000000-0000-4000-8000-000000000501';
SET @VP := '00000000-0000-4000-8000-000000000521';

-- ========== 预清理 ==========
-- 先清理可能存在的关联到同一个 VM 的数据
DELETE FROM vulnerability_metadata_exploit_status WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_credit_contact WHERE credit_id IN (SELECT id FROM vulnerability_metadata_credit WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_credit WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_contributor WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_patch_tag WHERE patch_detail_id IN (SELECT id FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_patch_branch WHERE patch_detail_id IN (SELECT id FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_affected_range_event WHERE range_id IN (SELECT id FROM vulnerability_metadata_affected_range WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001')));
DELETE FROM vulnerability_metadata_affected_range WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_affected_version WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_affected_commit WHERE package_id IN (SELECT id FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001'));
DELETE FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_severity WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_timeline WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_cwe WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_reference WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_alias WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_related WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM lnk_vulnerability_metadata_tag WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM lnk_vulnerability_metadata_user WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata_project WHERE vulnerability_metadata_id IN (SELECT id FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001');
DELETE FROM vulnerability_metadata WHERE uuid = @VM OR identifier = 'COSV-2025-000001';
DELETE FROM cosv_file WHERE uuid = @CF OR identifier = 'COSV-2025-000001';

-- 清理标签/分类/用户/组织（按唯一键）
DELETE FROM lnk_vulnerability_metadata_tag WHERE tag_id IN (SELECT id FROM tag WHERE code IN ('WEB','CWE-444','RCE'));
DELETE FROM tag WHERE code IN ('WEB','CWE-444','RCE') OR uuid IN (@TAG1,@TAG2,@TAG3);
DELETE FROM category WHERE code = 'HTTP_SMUGGLING' OR uuid = @CAT;

-- 清理组织关联（如存在）
DELETE FROM lnk_user_organization WHERE uuid = @LNK;
DELETE FROM organization WHERE uuid = @ORG OR name = 'Acme Security';
DELETE FROM user WHERE uuid IN (@U1,@U2) OR name IN ('tester','admin2') OR email IN ('tester@example.com','admin2@example.com');

-- ========== 插入基础字典 ==========
INSERT INTO user (uuid, name, password, role, email, avatar, company, location, git_hub, status, rating, website, free_text, real_name)
VALUES
  (@U1, 'tester', '$2a$10$hash', 'USER', 'tester@example.com', NULL, 'Acme Corp', 'Shenzhen, CN', 'https://github.com/tester', 'ACTIVE', 120, 'https://tester.dev', 'Security researcher', '张三'),
  (@U2, 'admin2', '$2a$10$hash', 'ADMIN', 'admin2@example.com', NULL, 'Acme Corp', 'Shenzhen, CN', NULL, 'ACTIVE', 999, NULL, 'System admin', '李四');

SELECT id INTO @U1_ID FROM user WHERE uuid = @U1;
SELECT id INTO @U2_ID FROM user WHERE uuid = @U2;

INSERT INTO organization (uuid, name, status, avatar, description, rating, free_text, is_public, allow_join_request, allow_invite_link)
VALUES (@ORG, 'Acme Security', 'ACTIVE', NULL, 'Security org for testing', 88, 'We secure open source.', 1, 1, 1);
SELECT id INTO @ORG_ID FROM organization WHERE uuid = @ORG;

INSERT INTO lnk_user_organization (uuid, organization_id, user_id, role)
VALUES (@LNK, @ORG_ID, @U1_ID, 'ADMIN');

INSERT INTO category (uuid, code, name, description)
VALUES (@CAT, 'HTTP_SMUGGLING', 'HTTP Request Smuggling', 'Smuggling via malformed request parsing');
SELECT id INTO @CAT_ID FROM category WHERE uuid = @CAT;

INSERT INTO tag (uuid, code, name)
VALUES
  (@TAG1, 'WEB', 'Web'),
  (@TAG2, 'CWE-444', 'HTTP Request Smuggling'),
  (@TAG3, 'RCE', 'Remote Code Execution');
SELECT id INTO @TAG_WEB FROM tag WHERE code = 'WEB';
SELECT id INTO @TAG_CWE FROM tag WHERE code = 'CWE-444';
SELECT id INTO @TAG_RCE FROM tag WHERE code = 'RCE';

-- ========== COSV 文件版本 ==========
INSERT INTO cosv_file (uuid, identifier, modified, prev_cosv_file_id, user_id, schema_version, raw_cosv_file_id)
VALUES (@CF, 'COSV-2025-000001', NOW(), NULL, @U1_ID, '1.0.0', NULL);
SELECT id INTO @CF_ID FROM cosv_file WHERE uuid = @CF;

-- ========== 漏洞主体 ==========
INSERT INTO vulnerability_metadata (
  uuid, identifier, summary, details, severity_num, modified, submitted, published, withdrawn,
  language, status, user_id, organization_id, category_id, latest_cosv_file_id, schema_version,
  review_date, reviewed_by, reject_reason, confirmed_type, database_specific
) VALUES (
  @VM,
  'COSV-2025-000001',
  'HTTP 请求走私导致前端代理绕过与缓存投毒',
  '受影响版本在处理分块请求与 Content-Length 头时解析不一致，攻击者可构造走私请求绕过WAF或污染下游缓存。\n\n影响：认证绕过、缓存投毒、请求伪造。\n缓解：升级至最新版本或启用一致性解析。',
  7.8,
  NOW(),
  '2025-07-15 12:00:00',
  '2025-07-16 09:00:00',
  '2025-07-20 00:00:00',
  'PYTHON',
  'ACTIVE',
  @U1_ID,
  @ORG_ID,
  @CAT_ID,
  @CF_ID,
  '1.0.0',
  '2025-07-16 10:00:00',
  @U2_ID,
  'N/A',
  'manual_confirmed',
  '{"source":"internal","cvss":"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:M/A:L","hot":true}'
);

SELECT id INTO @VM_ID FROM vulnerability_metadata WHERE uuid = @VM;

-- 关联标签 & 用户
INSERT INTO lnk_vulnerability_metadata_tag (vulnerability_metadata_id, tag_id) VALUES
  (@VM_ID, @TAG_WEB),
  (@VM_ID, @TAG_CWE),
  (@VM_ID, @TAG_RCE);

INSERT INTO lnk_vulnerability_metadata_user (vulnerability_metadata_id, user_id) VALUES (@VM_ID, @U1_ID);

-- 相关项目
INSERT INTO vulnerability_metadata_project (uuid, name, url, versions, vulnerability_metadata_id, type) VALUES
  (@VP, 'aiohttp', 'https://github.com/aio-libs/aiohttp', '3.12.0,3.12.1,3.12.2', @VM_ID, 'AFFECTED');

-- ========== COSV 子结构 ==========
INSERT INTO vulnerability_metadata_alias (vulnerability_metadata_id, value) VALUES
  (@VM_ID, 'CVE-2025-53643'),
  (@VM_ID, 'GHSA-xxxx-xxxx');

INSERT INTO vulnerability_metadata_related (vulnerability_metadata_id, value) VALUES
  (@VM_ID, 'CVE-2024-11111');

INSERT INTO vulnerability_metadata_reference (vulnerability_metadata_id, type, url) VALUES
  (@VM_ID, 'advisory', 'https://nvd.nist.gov/vuln/detail/CVE-2025-53643'),
  (@VM_ID, 'patch', 'https://github.com/aio-libs/aiohttp/commit/abcdef1234567890');

INSERT INTO vulnerability_metadata_cwe (vulnerability_metadata_id, cwe_id, cwe_name) VALUES
  (@VM_ID, 'CWE-444', 'HTTP Request Smuggling'),
  (@VM_ID, 'CWE-346', 'Origin Validation Error');

INSERT INTO vulnerability_metadata_timeline (vulnerability_metadata_id, type, value) VALUES
  (@VM_ID, 'disclosed', '2025-07-15 00:00:00'),
  (@VM_ID, 'fixed',     '2025-07-16 00:00:00'),
  (@VM_ID, 'published', '2025-07-16 09:00:00');

INSERT INTO vulnerability_metadata_severity (vulnerability_metadata_id, type, score, level, score_num) VALUES
  (@VM_ID, 'CVSS:3.1/BASE', 'AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:M/A:L', 'HIGH', 7.8),
  (@VM_ID, 'CVSS:4.0', 'CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:M/VA:L', 'MEDIUM', 6.3);

-- ========== Affected（受影响面） ==========
INSERT INTO vulnerability_metadata_affected_package (
  vulnerability_metadata_id, ecosystem, name, purl, language, repository, home_page, edition, ecosystem_specific, database_specific
) VALUES (
  @VM_ID, 'PyPI', 'aiohttp', 'pkg:pypi/aiohttp', 'PYTHON', 'https://github.com/aio-libs/aiohttp', 'https://pypi.org/project/aiohttp', NULL,
  '{"module":"aiohttp","import":"aiohttp.client"}',
  '{"severity":{"CVSS:3.1":7.8}}'
);

SELECT id INTO @PKG_ID FROM vulnerability_metadata_affected_package WHERE vulnerability_metadata_id = @VM_ID AND name = 'aiohttp' ORDER BY id DESC LIMIT 1;

INSERT INTO vulnerability_metadata_affected_commit (package_id, commit_type, commit_id) VALUES
  (@PKG_ID, 'INTRODUCED', 'deadbeef1'),
  (@PKG_ID, 'FIXED', 'f00ba47');

INSERT INTO vulnerability_metadata_affected_range (package_id, type, repo, database_specific) VALUES
  (@PKG_ID, 'SEMVER', '', NULL);

SELECT id INTO @RANGE_ID FROM vulnerability_metadata_affected_range WHERE package_id = @PKG_ID AND type = 'SEMVER' ORDER BY id DESC LIMIT 1;

INSERT INTO vulnerability_metadata_affected_range_event (range_id, event_type, value) VALUES
  (@RANGE_ID, 'introduced', '3.12.0'),
  (@RANGE_ID, 'fixed', '3.12.14');

INSERT INTO vulnerability_metadata_affected_version (package_id, version) VALUES
  (@PKG_ID, '3.12.0'),
  (@PKG_ID, '3.12.1'),
  (@PKG_ID, '3.12.2');

-- ========== Patch / Contributors / Credits / Exploit ==========
INSERT INTO vulnerability_metadata_patch_detail (vulnerability_metadata_id, patch_url, issue_url, main_language, author, committer) VALUES
  (@VM_ID, 'https://github.com/aio-libs/aiohttp/commit/abcdef1234567890', 'https://github.com/aio-libs/aiohttp/issues/123', 'Python', 'Alice', 'Bob');

SELECT id INTO @PD_ID FROM vulnerability_metadata_patch_detail WHERE vulnerability_metadata_id = @VM_ID ORDER BY id DESC LIMIT 1;

INSERT INTO vulnerability_metadata_patch_branch (patch_detail_id, name) VALUES
  (@PD_ID, 'main');

INSERT INTO vulnerability_metadata_patch_tag (patch_detail_id, name) VALUES
  (@PD_ID, 'v3.12.14');

INSERT INTO vulnerability_metadata_contributor (vulnerability_metadata_id, org, name, email, contributions) VALUES
  (@VM_ID, 'CSPioneer', 'Jeppe', 'jeppe@example.com', 'Report and PoC');

INSERT INTO vulnerability_metadata_credit (vulnerability_metadata_id, name, type) VALUES
  (@VM_ID, 'Security Team', 'reporter');

SELECT id INTO @CREDIT_ID FROM vulnerability_metadata_credit WHERE vulnerability_metadata_id = @VM_ID AND name = 'Security Team' ORDER BY id DESC LIMIT 1;

INSERT INTO vulnerability_metadata_credit_contact (credit_id, contact) VALUES
  (@CREDIT_ID, 'mailto:sec@example.com');

INSERT INTO vulnerability_metadata_exploit_status (vulnerability_metadata_id, status) VALUES
  (@VM_ID, 'exploited_in_the_wild');

COMMIT;

