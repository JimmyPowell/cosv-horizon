<template>
  <div>
    <div class="d-flex align-center mb-4">
      <h1 class="text-h5 font-weight-bold">漏洞详情（管理员）</h1>
      <v-spacer></v-spacer>
      <v-btn variant="text" prepend-icon="mdi-arrow-left" @click="goBack">返回</v-btn>
      <v-btn variant="text" :to="`/vulnerabilities/${uuid}`" prepend-icon="mdi-open-in-new">用户视图</v-btn>
    </div>

    <div v-if="loading" class="text-center py-12">
      <v-progress-circular indeterminate color="primary" size="64" />
    </div>

    <div v-else>
      <v-row>
        <v-col cols="12" md="8">
          <v-card class="mb-4">
            <v-card-title class="d-flex align-center">
              <v-chip color="primary" size="small" class="mr-2" variant="tonal">{{ vuln.identifier }}</v-chip>
              <v-chip size="small" :color="statusChipColor(vuln.status)" variant="tonal">{{ vuln.status }}</v-chip>
            </v-card-title>
            <v-divider></v-divider>
            <v-card-text>
              <v-form>
                <v-row>
                  <v-col cols="12">
                    <v-text-field v-model="edit.summary" label="摘要" hide-details required />
                  </v-col>
                  <v-col cols="12" md="4">
                    <v-text-field v-model.number="edit.severityNum" type="number" step="0.1" min="0" max="10" label="严重性" hide-details required />
                  </v-col>
                  <v-col cols="12" md="4">
                    <v-text-field v-model="edit.language" label="语言" hide-details required />
                  </v-col>
                  <v-col cols="12" md="4">
                    <v-autocomplete v-model="edit.categoryCode" :items="categoryOptions" label="分类代码" hide-details clearable />
                  </v-col>
                  <v-col cols="12">
                    <v-textarea v-model="edit.details" label="详情" hide-details rows="6" />
                  </v-col>
                </v-row>
              </v-form>
              <div class="d-flex justify-end">
                <v-btn color="primary" :loading="saving" @click="saveBasic">保存基本信息</v-btn>
              </div>
            </v-card-text>
          </v-card>

          <v-card class="mb-4">
            <v-card-title class="d-flex align-center">
              <v-icon class="mr-2">mdi-tag-outline</v-icon>标签
            </v-card-title>
            <v-divider></v-divider>
            <v-card-text>
              <div class="mb-3">
                <v-chip v-for="t in (vuln.tagCodes || [])" :key="t" class="mr-2 mb-2" size="small" color="secondary" variant="tonal">
                  {{ t }}
                  <v-btn icon size="x-small" variant="text" class="ml-1" @click="removeTag(t)"><v-icon size="16">mdi-close</v-icon></v-btn>
                </v-chip>
                <div v-if="!vuln.tagCodes || vuln.tagCodes.length === 0" class="text-grey">暂无标签</div>
              </div>
              <div class="d-flex" style="max-width: 480px">
                <v-autocomplete v-model="tagCodeInput" :items="tagOptions" label="按代码添加标签" hide-details clearable class="mr-2" />
                <v-btn color="primary" @click="addTag" :disabled="!tagCodeInput">添加</v-btn>
              </div>
            </v-card-text>
          </v-card>

          <v-card>
            <v-card-title class="d-flex align-center">
              <v-icon class="mr-2">mdi-file-document-outline</v-icon> COSV 概览
            </v-card-title>
            <v-divider></v-divider>
            <v-card-text>
              <div class="text-body-2 text-grey-darken-1 mb-4">完整 COSV 结构预览（按模块折叠展示）。</div>

              <v-expansion-panels multiple>
                <v-expansion-panel title="基本信息">
                  <v-expansion-panel-text>
                    <v-list density="compact">
                      <v-list-item><v-list-item-title>ID：{{ cosv.id || '-' }}</v-list-item-title></v-list-item>
                      <v-list-item><v-list-item-title>Schema：{{ cosv.schema_version || '-' }}</v-list-item-title></v-list-item>
                      <v-list-item><v-list-item-title>Published：{{ cosv.published || '-' }}</v-list-item-title></v-list-item>
                      <v-list-item><v-list-item-title>Modified：{{ cosv.modified || '-' }}</v-list-item-title></v-list-item>
                      <v-list-item><v-list-item-title>Withdrawn：{{ cosv.withdrawn || '-' }}</v-list-item-title></v-list-item>
                      <v-list-item><v-list-item-title>Confirmed Type：{{ cosv.confirmed_type || '-' }}</v-list-item-title></v-list-item>
                    </v-list>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="别名 / 关联 / 引用">
                  <v-expansion-panel-text>
                    <div class="mb-2"><strong>Aliases:</strong> <span v-if="cosv.aliases?.length">{{ cosv.aliases.join(', ') }}</span><span v-else class="text-grey">无</span></div>
                    <div class="mb-2"><strong>Related:</strong> <span v-if="cosv.related?.length">{{ cosv.related.join(', ') }}</span><span v-else class="text-grey">无</span></div>
                    <div class="mb-2">
                      <strong>References:</strong>
                      <div v-if="cosv.references?.length">
                        <div v-for="(r, idx) in cosv.references" :key="idx" class="text-truncate">
                          <span class="text-grey">{{ r.type || 'ref' }}：</span><a :href="r.url" target="_blank">{{ r.url }}</a>
                        </div>
                      </div>
                      <span v-else class="text-grey">无</span>
                    </div>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="CWE 与时间线">
                  <v-expansion-panel-text>
                    <div class="mb-2"><strong>CWE IDs:</strong> <span v-if="cosv.cwe_ids?.length">{{ cosv.cwe_ids.join(', ') }}</span><span v-else class="text-grey">无</span></div>
                    <div class="mb-2"><strong>CWE Names:</strong> <span v-if="cosv.cwe_names?.length">{{ cosv.cwe_names.join(', ') }}</span><span v-else class="text-grey">无</span></div>
                    <div class="mb-2">
                      <strong>时间线:</strong>
                      <div v-if="cosv.time_line?.length">
                        <div v-for="(t, idx) in cosv.time_line" :key="idx">{{ t.type }}：{{ t.value }}</div>
                      </div>
                      <span v-else class="text-grey">无</span>
                    </div>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="严重性（多量表）">
                  <v-expansion-panel-text>
                    <div v-if="cosv.severity?.length">
                      <v-table density="compact">
                        <thead><tr><th>Type</th><th>Score</th><th>Level</th><th>Score Num</th></tr></thead>
                        <tbody>
                          <tr v-for="(s, idx) in cosv.severity" :key="idx">
                            <td>{{ s.type }}</td>
                            <td>{{ s.score }}</td>
                            <td>{{ s.level }}</td>
                            <td>{{ s.score_num }}</td>
                          </tr>
                        </tbody>
                      </v-table>
                    </div>
                    <div v-else class="text-grey">无</div>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="受影响面（Affected）">
                  <v-expansion-panel-text>
                    <div v-if="cosv.affected?.length">
                      <div v-for="(a, idx) in cosv.affected" :key="idx" class="mb-4">
                        <div class="mb-1"><strong>Package:</strong> {{ a.package?.ecosystem || '-' }} / {{ a.package?.name || '-' }}</div>
                        <div v-if="a.ranges?.length" class="mb-1">
                          <div class="text-grey mb-1">Ranges:</div>
                          <v-table density="compact">
                            <thead><tr><th>Type</th><th>Repo</th><th>Events</th></tr></thead>
                            <tbody>
                              <tr v-for="(r, i2) in a.ranges" :key="i2">
                                <td>{{ r.type || '-' }}</td>
                                <td>{{ r.repo || '-' }}</td>
                                <td>
                                  <span v-if="r.events?.length">{{ r.events.map(e => `${Object.keys(e)[0]}:${Object.values(e)[0]}`).join(', ') }}</span>
                                  <span v-else class="text-grey">-</span>
                                </td>
                              </tr>
                            </tbody>
                          </v-table>
                        </div>
                        <div><strong>Versions:</strong> <span v-if="a.versions?.length">{{ a.versions.join(', ') }}</span><span v-else class="text-grey">无</span></div>
                      </div>
                    </div>
                    <div v-else class="text-grey">无</div>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="修复详情（Patch Details）">
                  <v-expansion-panel-text>
                    <div v-if="cosv.patch_details?.length">
                      <v-table density="compact">
                        <thead><tr><th>Patch</th><th>Issue</th><th>Main Language</th><th>Author</th><th>Committer</th></tr></thead>
                        <tbody>
                          <tr v-for="(p, idx) in cosv.patch_details" :key="idx">
                            <td><a :href="p.patch_url" target="_blank">{{ p.patch_url }}</a></td>
                            <td><a :href="p.issue_url" target="_blank">{{ p.issue_url }}</a></td>
                            <td>{{ p.main_language || '-' }}</td>
                            <td>{{ p.author || '-' }}</td>
                            <td>{{ p.committer || '-' }}</td>
                          </tr>
                        </tbody>
                      </v-table>
                    </div>
                    <div v-else class="text-grey">无</div>
                  </v-expansion-panel-text>
                </v-expansion-panel>

                <v-expansion-panel title="贡献者 / 致谢 / 利用状态">
                  <v-expansion-panel-text>
                    <div class="mb-2"><strong>Contributors:</strong>
                      <span v-if="cosv.contributors?.length">{{ cosv.contributors.map(c => `${c.org || ''} ${c.name || ''}`.trim()).join('; ') }}</span>
                      <span v-else class="text-grey">无</span>
                    </div>
                    <div class="mb-2"><strong>Credits:</strong>
                      <span v-if="cosv.credits?.length">{{ cosv.credits.map(c => c.name).join(', ') }}</span>
                      <span v-else class="text-grey">无</span>
                    </div>
                    <div class="mb-2"><strong>Exploit Status:</strong>
                      <span v-if="cosv.exploit_status?.length">{{ cosv.exploit_status.join(', ') }}</span>
                      <span v-else class="text-grey">无</span>
                    </div>
                  </v-expansion-panel-text>
                </v-expansion-panel>
              </v-expansion-panels>
            </v-card-text>
          </v-card>
        </v-col>

        <v-col cols="12" md="4">
          <v-card>
            <v-card-title>审核与状态</v-card-title>
            <v-divider></v-divider>
            <v-card-text>
              <div class="mb-2"><strong>当前状态：</strong><v-chip size="small" :color="statusChipColor(vuln.status)" variant="tonal">{{ vuln.status }}</v-chip></div>
              <v-select v-model="statusEdit" :items="statusOptions" label="快速设置状态" hide-details density="comfortable" class="mb-3" />
              <v-textarea v-if="statusEdit==='REJECTED'" v-model="rejectReason" label="拒绝原因（可选）" hide-details rows="2" class="mb-3" />
              <div class="d-flex flex-wrap gap-2">
                <v-btn color="success" variant="tonal" class="mr-2 mb-2" :loading="acting" @click="applyStatus('ACTIVE')">通过</v-btn>
                <v-btn color="error" variant="tonal" class="mr-2 mb-2" :loading="acting" @click="applyStatus('REJECTED')">拒绝</v-btn>
                <v-btn color="info" variant="tonal" class="mb-2" :loading="acting" @click="applyStatus(statusEdit)">更新状态</v-btn>
              </div>
              <v-divider class="my-4" />
              <div class="text-subtitle-2 mb-2">搜索索引</div>
              <div class="d-flex flex-wrap gap-2">
                <v-btn color="primary" variant="outlined" :loading="indexing" @click="reindexOne">重建索引</v-btn>
              </div>
            </v-card-text>
          </v-card>
          <v-card class="mt-4">
            <v-card-title>基础信息</v-card-title>
            <v-divider></v-divider>
            <v-card-text>
              <div class="mb-2"><strong>UUID：</strong><code>{{ vuln.uuid }}</code></div>
              <div class="mb-2"><strong>提交者：</strong>{{ vuln.submitterType==='ORG' ? '组织' : '用户' }}</div>
              <div class="mb-2"><strong>提交时间：</strong>{{ formatDateTime(vuln.submitted) }}</div>
              <div class="mb-2"><strong>更新时间：</strong>{{ formatDateTime(vuln.modified) }}</div>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import adminVulnApi from '@/api/admin/vulnerabilities';
import adminSearch from '@/api/admin/search';
import adminTagApi from '@/api/admin/tags';
import adminCategoryApi from '@/api/admin/categories';

const route = useRoute();
const router = useRouter();
const uuid = route.params.uuid;

const loading = ref(false);
const saving = ref(false);
const acting = ref(false);
const indexing = ref(false);
const vuln = ref({});
const cosv = ref({});

const edit = ref({ summary: '', details: '', severityNum: undefined, language: '', categoryCode: '' });
const statusOptions = ['PENDING','ACTIVE','REJECTED','FIXED'];
const statusEdit = ref('');
const rejectReason = ref('');

const categoryOptions = ref([]);
const tagOptions = ref([]);
const tagCodeInput = ref('');

const statusChipColor = (s) => ({ ACTIVE: 'success', PENDING: 'warning', REJECTED: 'error', FIXED: 'info' }[s] || 'grey');
const formatDateTime = (iso) => { if (!iso) return '-'; try { return new Date(iso).toLocaleString('zh-CN'); } catch { return iso; } };

async function fetchAll() {
  loading.value = true;
  try {
    // details
    const data = await adminVulnApi.get(uuid);
    const v = data?.vulnerability || {};
    vuln.value = v;
    cosv.value = data?.cosv || {};
    edit.value = { summary: v.summary, details: v.details, severityNum: v.severityNum, language: v.language, categoryCode: v.categoryCode || '' };
    statusEdit.value = v.status;
    // options
    try {
      const [cats, tags] = await Promise.all([
        adminCategoryApi.list({ page: 1, size: 200, withTotal: false }),
        adminTagApi.list({ page: 1, size: 200, withTotal: false }),
      ]);
      categoryOptions.value = (cats.items || []).map(c => c.code);
      tagOptions.value = (tags.items || []).map(t => t.code);
    } catch {}
  } finally {
    loading.value = false;
  }
}

async function saveBasic() {
  saving.value = true;
  try {
    await adminVulnApi.update(uuid, { ...edit.value });
    await fetchAll();
  } finally { saving.value = false; }
}

async function applyStatus(target) {
  if (!target) return;
  acting.value = true;
  try {
    await adminVulnApi.updateStatus(uuid, { status: target, rejectReason: target==='REJECTED' ? (rejectReason.value || undefined) : undefined });
    await fetchAll();
  } finally { acting.value = false; }
}

async function addTag() {
  if (!tagCodeInput.value) return;
  await adminVulnApi.addTag(uuid, { code: tagCodeInput.value });
  tagCodeInput.value = '';
  await fetchAll();
}
async function removeTag(nameOrCode) {
  await adminVulnApi.removeTag(uuid, nameOrCode);
  await fetchAll();
}

async function reindexOne() {
  indexing.value = true;
  try {
    await adminSearch.indexOne(uuid);
  } finally { indexing.value = false; }
}

function goBack() {
  const from = route.query.from;
  if (from === 'admin-vuln-review') router.push('/admin/vulnerabilities/review');
  else router.push('/admin/vulnerabilities');
}

onMounted(fetchAll);
</script>

<style scoped>
</style>
