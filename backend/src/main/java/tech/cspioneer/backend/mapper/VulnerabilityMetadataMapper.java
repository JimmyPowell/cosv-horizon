package tech.cspioneer.backend.mapper;

import org.apache.ibatis.annotations.*;
import tech.cspioneer.backend.entity.VulnerabilityMetadata;

import java.util.List;

@Mapper
public interface VulnerabilityMetadataMapper {

    @Select("SELECT id, uuid, identifier, summary, details, severity_num AS severityNum, modified, submitted, published, withdrawn, language, status, user_id AS userId, organization_id AS organizationId, latest_cosv_file_id AS latestCosvFileId, schema_version AS schemaVersion, category_id AS categoryId, review_date AS reviewDate, reviewed_by AS reviewedBy, reject_reason AS rejectReason, confirmed_type AS confirmedType, database_specific AS databaseSpecific FROM vulnerability_metadata WHERE uuid = #{uuid} LIMIT 1")
    VulnerabilityMetadata findByUuid(@Param("uuid") String uuid);

    @Select("SELECT id, uuid, identifier, summary, details, severity_num AS severityNum, modified, submitted, published, withdrawn, language, status, user_id AS userId, organization_id AS organizationId, latest_cosv_file_id AS latestCosvFileId, schema_version AS schemaVersion, category_id AS categoryId, review_date AS reviewDate, reviewed_by AS reviewedBy, reject_reason AS rejectReason, confirmed_type AS confirmedType, database_specific AS databaseSpecific FROM vulnerability_metadata WHERE identifier = #{identifier} LIMIT 1")
    VulnerabilityMetadata findByIdentifier(@Param("identifier") String identifier);

    @Insert("INSERT INTO vulnerability_metadata(uuid, identifier, summary, details, severity_num, modified, submitted, language, status, user_id, organization_id, latest_cosv_file_id, category_id, schema_version) VALUES(#{uuid}, #{identifier}, #{summary}, #{details}, #{severityNum}, NOW(), NOW(), #{language}, #{status}, #{userId}, #{organizationId}, #{latestCosvFileId}, #{categoryId}, #{schemaVersion})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insert(VulnerabilityMetadata vm);

    @Update({
            "<script>",
            "UPDATE vulnerability_metadata",
            "<set>",
            "<if test='summary != null'> summary = #{summary}, </if>",
            "<if test='details != null'> details = #{details}, </if>",
            "<if test='severityNum != null'> severity_num = #{severityNum}, </if>",
            "<if test='language != null'> language = #{language}, </if>",
            "<if test='status != null'> status = #{status}, </if>",
            "<if test='categoryId != null'> category_id = #{categoryId}, </if>",
            " modified = NOW()",
            "</set>",
            "WHERE uuid = #{uuid}",
            "</script>"
    })
    int updateBasic(VulnerabilityMetadata vm);

    @Update({
            "<script>",
            "UPDATE vulnerability_metadata",
            "<set>",
            "<if test='published != null'> published = #{published}, </if>",
            "<if test='withdrawn != null'> withdrawn = #{withdrawn}, </if>",
            "<if test='schemaVersion != null'> schema_version = #{schemaVersion}, </if>",
            "<if test='confirmedType != null'> confirmed_type = #{confirmedType}, </if>",
            "<if test='databaseSpecific != null'> database_specific = #{databaseSpecific}, </if>",
            " modified = NOW()",
            "</set>",
            "WHERE uuid = #{uuid}",
            "</script>"
    })
    int updateCosvExtras(VulnerabilityMetadata vm);

    @Update("UPDATE vulnerability_metadata SET latest_cosv_file_id = #{fileId}, modified = NOW() WHERE id = #{id}")
    int updateLatestCosvFileIdById(@Param("id") Long id, @Param("fileId") Long fileId);

    @Update("UPDATE vulnerability_metadata SET category_id = NULL, modified = NOW() WHERE uuid = #{uuid}")
    int clearCategoryByUuid(@Param("uuid") String uuid);

    @Update("UPDATE vulnerability_metadata SET category_id = NULL, modified = NOW() WHERE category_id = #{categoryId}")
    int clearCategoryById(@Param("categoryId") Long categoryId);

    @Update("UPDATE vulnerability_metadata SET category_id = #{toCategoryId}, modified = NOW() WHERE category_id = #{fromCategoryId}")
    int remapCategory(@Param("fromCategoryId") Long fromCategoryId, @Param("toCategoryId") Long toCategoryId);

    @Select("SELECT COUNT(1) FROM vulnerability_metadata WHERE category_id = #{categoryId}")
    long countByCategoryId(@Param("categoryId") Long categoryId);

    @Select("SELECT id, uuid, identifier, summary FROM vulnerability_metadata WHERE category_id = #{categoryId} ORDER BY modified DESC LIMIT #{limit}")
    java.util.List<VulnerabilityMetadata> sampleByCategoryId(@Param("categoryId") Long categoryId, @Param("limit") int limit);

    @Select({
            "SELECT COUNT(1)",
            "FROM vulnerability_metadata vm JOIN lnk_vulnerability_metadata_tag l ON l.vulnerability_metadata_id = vm.id",
            "WHERE l.tag_id = #{tagId}"
    })
    long countByTagId(@Param("tagId") Long tagId);

    @Select({
            "SELECT vm.id, vm.uuid, vm.identifier, vm.summary",
            "FROM vulnerability_metadata vm JOIN lnk_vulnerability_metadata_tag l ON l.vulnerability_metadata_id = vm.id",
            "WHERE l.tag_id = #{tagId}",
            "ORDER BY vm.modified DESC",
            "LIMIT #{limit}"
    })
    java.util.List<VulnerabilityMetadata> sampleByTagId(@Param("tagId") Long tagId, @Param("limit") int limit);

    @Select({
            "<script>",
            "SELECT vm.id, vm.uuid, vm.identifier, vm.summary, vm.details, vm.severity_num AS severityNum, vm.modified, vm.submitted, vm.published, vm.withdrawn, vm.language, vm.status, vm.user_id AS userId, vm.organization_id AS organizationId, vm.latest_cosv_file_id AS latestCosvFileId, vm.schema_version AS schemaVersion, vm.category_id AS categoryId",
            "FROM vulnerability_metadata vm",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            "<if test='language != null'> AND vm.language = #{language} </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='organizationId != null'> AND vm.organization_id = #{organizationId} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "ORDER BY ${orderBy}",
            "LIMIT #{limit} OFFSET #{offset}",
            "</script>"
    })
    List<VulnerabilityMetadata> listByFilters(@Param("language") String language,
                                              @Param("status") String status,
                                              @Param("identifierPrefix") String identifierPrefix,
                                              @Param("tagName") String tagName,
                                              @Param("tagCode") String tagCode,
                                              @Param("organizationId") Long organizationId,
                                              @Param("categoryId") Long categoryId,
                                              @Param("submittedFrom") String submittedFrom,
                                              @Param("submittedTo") String submittedTo,
                                              @Param("modifiedFrom") String modifiedFrom,
                                              @Param("modifiedTo") String modifiedTo,
                                              @Param("orderBy") String orderBy,
                                              @Param("limit") int limit,
                                              @Param("offset") int offset);

    // Advanced filters: languages CSV and severity level buckets
    @Select({
            "<script>",
            "SELECT vm.id, vm.uuid, vm.identifier, vm.summary, vm.details, vm.severity_num AS severityNum, vm.modified, vm.submitted, vm.published, vm.withdrawn, vm.language, vm.status, vm.user_id AS userId, vm.organization_id AS organizationId, vm.latest_cosv_file_id AS latestCosvFileId, vm.schema_version AS schemaVersion, vm.category_id AS categoryId",
            "FROM vulnerability_metadata vm",
            "LEFT JOIN organization o ON o.id = vm.organization_id",
            "LEFT JOIN lnk_user_organization uo ON uo.organization_id = vm.organization_id AND uo.user_id = #{currentUserId}",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            "<if test='languagesCSV != null and languagesCSV != \"\"'> AND FIND_IN_SET(vm.language, #{languagesCSV}) </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='organizationId != null'> AND vm.organization_id = #{organizationId} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "<if test='sevCritical or sevHigh or sevMedium or sevLow'> AND (",
            "  <if test='sevCritical'> (vm.severity_num &gt;= 9.0) </if>",
            "  <if test='sevHigh'> <if test='sevCritical'> OR </if> (vm.severity_num &gt;= 7.0 AND vm.severity_num &lt; 9.0) </if>",
            "  <if test='sevMedium'> <if test='sevCritical or sevHigh'> OR </if> (vm.severity_num &gt;= 4.0 AND vm.severity_num &lt; 7.0) </if>",
            "  <if test='sevLow'> <if test='sevCritical or sevHigh or sevMedium'> OR </if> (vm.severity_num &gt;= 0.0 AND vm.severity_num &lt; 4.0) </if>",
            ") </if>",
            "<if test='severityGe != null'> AND vm.severity_num &gt;= #{severityGe} </if>",
            "<if test='severityLe != null'> AND vm.severity_num &lt;= #{severityLe} </if>",
            "<if test='enforceVisibility != null and enforceVisibility'>",
            "  AND (vm.organization_id IS NULL OR o.is_public = 1 OR uo.id IS NOT NULL)",
            "  AND (uo.id IS NOT NULL OR vm.organization_id IS NULL OR o.is_public = 0 OR #{restrictPublicToActive} = false OR vm.status = 'ACTIVE')",
            "</if>",
            "ORDER BY ${orderBy}",
            "LIMIT #{limit} OFFSET #{offset}",
            "</script>"
    })
    List<VulnerabilityMetadata> listByFiltersAdv(@Param("languagesCSV") String languagesCSV,
                                                 @Param("status") String status,
                                                 @Param("identifierPrefix") String identifierPrefix,
                                                 @Param("q") String q,
                                                 @Param("tagName") String tagName,
                                                 @Param("tagCode") String tagCode,
                                                 @Param("organizationId") Long organizationId,
                                                 @Param("categoryId") Long categoryId,
                                                 @Param("submittedFrom") String submittedFrom,
                                                 @Param("submittedTo") String submittedTo,
                                                 @Param("modifiedFrom") String modifiedFrom,
                                                 @Param("modifiedTo") String modifiedTo,
                                                 @Param("sevCritical") Boolean sevCritical,
                                                 @Param("sevHigh") Boolean sevHigh,
                                                 @Param("sevMedium") Boolean sevMedium,
                                                 @Param("sevLow") Boolean sevLow,
                                                 @Param("severityGe") Float severityGe,
                                                 @Param("severityLe") Float severityLe,
                                                 @Param("orderBy") String orderBy,
                                                 @Param("limit") int limit,
                                                 @Param("offset") int offset,
                                                 @Param("currentUserId") Long currentUserId,
                                                 @Param("enforceVisibility") Boolean enforceVisibility,
                                                 @Param("restrictPublicToActive") Boolean restrictPublicToActive);

    // Mine-only variants: vm.user_id = userId OR vm.organization_id IN (adminOrgIds)
    @Select({
            "<script>",
            "SELECT vm.id, vm.uuid, vm.identifier, vm.summary, vm.details, vm.severity_num AS severityNum, vm.modified, vm.submitted, vm.published, vm.withdrawn, vm.language, vm.status, vm.user_id AS userId, vm.organization_id AS organizationId, vm.latest_cosv_file_id AS latestCosvFileId, vm.schema_version AS schemaVersion, vm.category_id AS categoryId, vm.review_date AS reviewDate, vm.reviewed_by AS reviewedBy, vm.reject_reason AS rejectReason, vm.confirmed_type AS confirmedType, vm.database_specific AS databaseSpecific",
            "FROM vulnerability_metadata vm",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            " AND (vm.user_id = #{userId} ",
            "<if test='adminOrgIds != null and adminOrgIds.size > 0'> OR vm.organization_id IN ",
            "  <foreach item='oid' collection='adminOrgIds' open='(' separator=',' close=')'>#{oid}</foreach>",
            "</if>)",
            "<if test='languagesCSV != null and languagesCSV != \"\"'> AND FIND_IN_SET(vm.language, #{languagesCSV}) </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "<if test='sevCritical or sevHigh or sevMedium or sevLow'> AND (",
            "  <if test='sevCritical'> (vm.severity_num &gt;= 9.0) </if>",
            "  <if test='sevHigh'> <if test='sevCritical'> OR </if> (vm.severity_num &gt;= 7.0 AND vm.severity_num &lt; 9.0) </if>",
            "  <if test='sevMedium'> <if test='sevCritical or sevHigh'> OR </if> (vm.severity_num &gt;= 4.0 AND vm.severity_num &lt; 7.0) </if>",
            "  <if test='sevLow'> <if test='sevCritical or sevHigh or sevMedium'> OR </if> (vm.severity_num &gt;= 0.0 AND vm.severity_num &lt; 4.0) </if>",
            ") </if>",
            "<if test='severityGe != null'> AND vm.severity_num &gt;= #{severityGe} </if>",
            "<if test='severityLe != null'> AND vm.severity_num &lt;= #{severityLe} </if>",
            "ORDER BY ${orderBy}",
            "LIMIT #{limit} OFFSET #{offset}",
            "</script>"
    })
    List<VulnerabilityMetadata> listMineByFiltersAdv(@Param("userId") Long userId,
                                                     @Param("adminOrgIds") java.util.List<Long> adminOrgIds,
                                                     @Param("languagesCSV") String languagesCSV,
                                                     @Param("status") String status,
                                                     @Param("identifierPrefix") String identifierPrefix,
                                                     @Param("q") String q,
                                                     @Param("tagName") String tagName,
                                                     @Param("tagCode") String tagCode,
                                                     @Param("categoryId") Long categoryId,
                                                     @Param("submittedFrom") String submittedFrom,
                                                     @Param("submittedTo") String submittedTo,
                                                     @Param("modifiedFrom") String modifiedFrom,
                                                     @Param("modifiedTo") String modifiedTo,
                                                     @Param("sevCritical") Boolean sevCritical,
                                                     @Param("sevHigh") Boolean sevHigh,
                                                     @Param("sevMedium") Boolean sevMedium,
                                                     @Param("sevLow") Boolean sevLow,
                                                     @Param("severityGe") Float severityGe,
                                                     @Param("severityLe") Float severityLe,
                                                     @Param("orderBy") String orderBy,
                                                     @Param("limit") int limit,
                                                     @Param("offset") int offset);

    @Delete("DELETE FROM vulnerability_metadata WHERE id = #{id}")
    int deleteById(@Param("id") Long id);

    @Select({
            "<script>",
            "SELECT COUNT(1)",
            "FROM vulnerability_metadata vm",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            " AND (vm.user_id = #{userId} ",
            "<if test='adminOrgIds != null and adminOrgIds.size > 0'> OR vm.organization_id IN ",
            "  <foreach item='oid' collection='adminOrgIds' open='(' separator=',' close=')'>#{oid}</foreach>",
            "</if>)",
            "<if test='languagesCSV != null and languagesCSV != \"\"'> AND FIND_IN_SET(vm.language, #{languagesCSV}) </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "<if test='sevCritical or sevHigh or sevMedium or sevLow'> AND (",
            "  <if test='sevCritical'> (vm.severity_num &gt;= 9.0) </if>",
            "  <if test='sevHigh'> <if test='sevCritical'> OR </if> (vm.severity_num &gt;= 7.0 AND vm.severity_num &lt; 9.0) </if>",
            "  <if test='sevMedium'> <if test='sevCritical or sevHigh'> OR </if> (vm.severity_num &gt;= 4.0 AND vm.severity_num &lt; 7.0) </if>",
            "  <if test='sevLow'> <if test='sevCritical or sevHigh or sevMedium'> OR </if> (vm.severity_num &gt;= 0.0 AND vm.severity_num &lt; 4.0) </if>",
            ") </if>",
            "<if test='severityGe != null'> AND vm.severity_num &gt;= #{severityGe} </if>",
            "<if test='severityLe != null'> AND vm.severity_num &lt;= #{severityLe} </if>",
            "</script>"
    })
    long countMineByFiltersAdv(@Param("userId") Long userId,
                               @Param("adminOrgIds") java.util.List<Long> adminOrgIds,
                               @Param("languagesCSV") String languagesCSV,
                               @Param("status") String status,
                               @Param("identifierPrefix") String identifierPrefix,
                               @Param("q") String q,
                               @Param("tagName") String tagName,
                               @Param("tagCode") String tagCode,
                               @Param("categoryId") Long categoryId,
                               @Param("submittedFrom") String submittedFrom,
                               @Param("submittedTo") String submittedTo,
                               @Param("modifiedFrom") String modifiedFrom,
                               @Param("modifiedTo") String modifiedTo,
                               @Param("sevCritical") Boolean sevCritical,
                               @Param("sevHigh") Boolean sevHigh,
                               @Param("sevMedium") Boolean sevMedium,
                               @Param("sevLow") Boolean sevLow,
                               @Param("severityGe") Float severityGe,
                               @Param("severityLe") Float severityLe);

    @Select({
            "<script>",
            "SELECT COUNT(1)",
            "FROM vulnerability_metadata vm",
            "LEFT JOIN organization o ON o.id = vm.organization_id",
            "LEFT JOIN lnk_user_organization uo ON uo.organization_id = vm.organization_id AND uo.user_id = #{currentUserId}",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            "<if test='languagesCSV != null and languagesCSV != \"\"'> AND FIND_IN_SET(vm.language, #{languagesCSV}) </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='organizationId != null'> AND vm.organization_id = #{organizationId} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "<if test='sevCritical or sevHigh or sevMedium or sevLow'> AND (",
            "  <if test='sevCritical'> (vm.severity_num &gt;= 9.0) </if>",
            "  <if test='sevHigh'> <if test='sevCritical'> OR </if> (vm.severity_num &gt;= 7.0 AND vm.severity_num &lt; 9.0) </if>",
            "  <if test='sevMedium'> <if test='sevCritical or sevHigh'> OR </if> (vm.severity_num &gt;= 4.0 AND vm.severity_num &lt; 7.0) </if>",
            "  <if test='sevLow'> <if test='sevCritical or sevHigh or sevMedium'> OR </if> (vm.severity_num &gt;= 0.0 AND vm.severity_num &lt; 4.0) </if>",
            ") </if>",
            "<if test='severityGe != null'> AND vm.severity_num &gt;= #{severityGe} </if>",
            "<if test='severityLe != null'> AND vm.severity_num &lt;= #{severityLe} </if>",
            "<if test='enforceVisibility != null and enforceVisibility'>",
            "  AND (vm.organization_id IS NULL OR o.is_public = 1 OR uo.id IS NOT NULL)",
            "  AND (uo.id IS NOT NULL OR vm.organization_id IS NULL OR o.is_public = 0 OR #{restrictPublicToActive} = false OR vm.status = 'ACTIVE')",
            "</if>",
            "</script>"
    })
    long countByFiltersAdv(@Param("languagesCSV") String languagesCSV,
                           @Param("status") String status,
                           @Param("identifierPrefix") String identifierPrefix,
                           @Param("q") String q,
                           @Param("tagName") String tagName,
                           @Param("tagCode") String tagCode,
                           @Param("organizationId") Long organizationId,
                           @Param("categoryId") Long categoryId,
                           @Param("submittedFrom") String submittedFrom,
                           @Param("submittedTo") String submittedTo,
                           @Param("modifiedFrom") String modifiedFrom,
                           @Param("modifiedTo") String modifiedTo,
                           @Param("sevCritical") Boolean sevCritical,
                           @Param("sevHigh") Boolean sevHigh,
                           @Param("sevMedium") Boolean sevMedium,
                           @Param("sevLow") Boolean sevLow,
                           @Param("severityGe") Float severityGe,
                           @Param("severityLe") Float severityLe,
                           @Param("currentUserId") Long currentUserId,
                           @Param("enforceVisibility") Boolean enforceVisibility,
                           @Param("restrictPublicToActive") Boolean restrictPublicToActive);

    @Select({
            "<script>",
            "SELECT COUNT(1)",
            "FROM vulnerability_metadata vm",
            "<if test='tagName != null or tagCode != null'> JOIN lnk_vulnerability_metadata_tag lvt ON lvt.vulnerability_metadata_id = vm.id JOIN tag t ON t.id = lvt.tag_id </if>",
            "WHERE 1=1",
            "<if test='language != null'> AND vm.language = #{language} </if>",
            "<if test='status != null'> AND vm.status = #{status} </if>",
            "<if test='identifierPrefix != null'> AND vm.identifier LIKE CONCAT(#{identifierPrefix}, '%') </if>",
            "<if test='q != null and q != \"\"'> AND (",
            "  vm.identifier LIKE CONCAT(#{q}, '%')",
            "  OR vm.summary LIKE CONCAT('%', #{q}, '%')",
            "  OR EXISTS (SELECT 1 FROM vulnerability_metadata_alias a WHERE a.vulnerability_metadata_id = vm.id AND a.value LIKE CONCAT(#{q}, '%'))",
            ") </if>",
            "<if test='tagName != null'> AND t.name = #{tagName} </if>",
            "<if test='tagCode != null'> AND t.code = #{tagCode} </if>",
            "<if test='organizationId != null'> AND vm.organization_id = #{organizationId} </if>",
            "<if test='categoryId != null'> AND vm.category_id = #{categoryId} </if>",
            "<if test='submittedFrom != null'> AND vm.submitted &gt;= #{submittedFrom} </if>",
            "<if test='submittedTo != null'> AND vm.submitted &lt;= #{submittedTo} </if>",
            "<if test='modifiedFrom != null'> AND vm.modified &gt;= #{modifiedFrom} </if>",
            "<if test='modifiedTo != null'> AND vm.modified &lt;= #{modifiedTo} </if>",
            "</script>"
    })
    long countByFilters(@Param("language") String language,
                        @Param("status") String status,
                        @Param("identifierPrefix") String identifierPrefix,
                        @Param("tagName") String tagName,
                        @Param("tagCode") String tagCode,
                        @Param("organizationId") Long organizationId,
                        @Param("categoryId") Long categoryId,
                        @Param("submittedFrom") String submittedFrom,
                        @Param("submittedTo") String submittedTo,
                        @Param("modifiedFrom") String modifiedFrom,
                        @Param("modifiedTo") String modifiedTo);

    @Update({
            "<script>",
            "UPDATE vulnerability_metadata",
            "<set>",
            "  <if test='status != null'> status = #{status},</if>",
            "  <if test='rejectReasonSet'> reject_reason = #{rejectReason},</if>",
            "  <if test='reviewDate != null'> review_date = #{reviewDate},</if>",
            "  <if test='reviewedBy != null'> reviewed_by = #{reviewedBy},</if>",
            "  modified = NOW()",
            "</set>",
            "WHERE uuid = #{uuid}",
            "</script>"
    })
    int updateStatusReviewByUuid(@Param("uuid") String uuid,
                                 @Param("status") String status,
                                 @Param("rejectReason") String rejectReason,
                                 @Param("rejectReasonSet") boolean rejectReasonSet,
                                 @Param("reviewDate") java.time.LocalDateTime reviewDate,
                                 @Param("reviewedBy") Long reviewedBy);

    // ========== User Statistics ==========

    @Select("SELECT COUNT(1) FROM vulnerability_metadata WHERE user_id = #{userId}")
    long countByUserId(@Param("userId") Long userId);

    @Select({
            "SELECT DATE(submitted) as date, COUNT(*) as count",
            "FROM vulnerability_metadata",
            "WHERE user_id = #{userId}",
            "  AND submitted >= #{startDate}",
            "  AND submitted < #{endDate}",
            "GROUP BY DATE(submitted)",
            "ORDER BY DATE(submitted)"
    })
    List<java.util.Map<String, Object>> getContributionsByUserIdAndDateRange(
            @Param("userId") Long userId,
            @Param("startDate") String startDate,
            @Param("endDate") String endDate);

    // ========== Scanning for ES indexing ==========
    @Select({
            "SELECT id, uuid, identifier, summary, details, severity_num AS severityNum, modified, submitted, published, withdrawn, language, status, user_id AS userId, organization_id AS organizationId, category_id AS categoryId, latest_cosv_file_id AS latestCosvFileId, schema_version AS schemaVersion",
            "FROM vulnerability_metadata",
            "WHERE id > #{afterId}",
            "ORDER BY id ASC",
            "LIMIT #{limit}"
    })
    java.util.List<VulnerabilityMetadata> scanForIndexing(@Param("afterId") long afterId, @Param("limit") int limit);
}
