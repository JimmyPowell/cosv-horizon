package tech.cspioneer.backend.controller;

import tech.cspioneer.backend.entity.VulnerabilityMetadata;
import tech.cspioneer.backend.mapper.TagMapper;
import tech.cspioneer.backend.mapper.CategoryMapper;

import java.util.HashMap;
import java.util.Map;

/**
 * 复用漏洞视图映射的帮助类，避免多个控制器重复实现。
 */
public final class VulnerabilityControllerHelper {
    private VulnerabilityControllerHelper() {}

    public static Map<String, Object> vmView(VulnerabilityMetadata vm, TagMapper tagMapper, CategoryMapper categoryMapper) {
        Map<String, Object> m = new HashMap<>();
        m.put("uuid", vm.getUuid());
        m.put("identifier", vm.getIdentifier());
        m.put("summary", vm.getSummary());
        m.put("details", vm.getDetails());
        m.put("severityNum", vm.getSeverityNum());
        m.put("modified", vm.getModified());
        m.put("submitted", vm.getSubmitted());
        m.put("published", vm.getPublished());
        m.put("withdrawn", vm.getWithdrawn());
        m.put("language", vm.getLanguage());
        m.put("status", vm.getStatus());
        m.put("schemaVersion", vm.getSchemaVersion());
        m.put("confirmedType", vm.getConfirmedType());
        m.put("userId", null);
        m.put("submitterType", vm.getOrganizationId() != null ? "ORG" : "USER");
        if (categoryMapper != null && vm.getCategoryId() != null) {
            var c = categoryMapper.findById(vm.getCategoryId());
            if (c != null) m.put("categoryCode", c.getCode());
        }
        if (tagMapper != null && vm.getId() != null) {
            var tags = tagMapper.listByVulnerabilityId(vm.getId());
            if (tags != null) {
                m.put("tagCodes", tags.stream().map(t -> t.getCode()).toList());
            }
        }
        return m;
    }
}

