package tech.cspioneer.backend.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import org.springframework.web.bind.annotation.*;
import tech.cspioneer.backend.common.ApiResponse;
import tech.cspioneer.backend.dto.CommentView;
import tech.cspioneer.backend.service.VulnerabilityCommentService;

import java.security.Principal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/vulns/{uuid}/comments")
@Tag(name = "漏洞评论")
@SecurityRequirement(name = "bearerAuth")
public class VulnerabilityCommentController {
    private final VulnerabilityCommentService service;

    public VulnerabilityCommentController(VulnerabilityCommentService service) {
        this.service = service;
    }

    @GetMapping
    @Operation(summary = "评论列表（仅ACTIVE）")
    @org.springframework.security.access.prepost.PreAuthorize("hasAnyRole('USER','ADMIN') or hasAuthority('SCOPE_vuln:read')")
    public ApiResponse<Map<String, Object>> list(@PathVariable("uuid") String vulnUuid,
                                                 @RequestParam(value = "page", defaultValue = "1") int page,
                                                 @RequestParam(value = "size", defaultValue = "20") int size,
                                                 Principal principal) {
        var p = service.list(principal.getName(), vulnUuid, page, size);
        Map<String, Object> data = new HashMap<>();
        data.put("page", p.page());
        data.put("size", p.size());
        data.put("items", p.items());
        data.put("total", p.total());
        return ApiResponse.success(data);
    }

    public static class CreateReq { @NotBlank public String content; public String parentUuid; }

    @PostMapping
    @Operation(summary = "发表评论")
    @org.springframework.security.access.prepost.PreAuthorize("hasAnyRole('USER','ADMIN')")
    public ApiResponse<Map<String, Object>> create(@PathVariable("uuid") String vulnUuid,
                                                   @Valid @RequestBody CreateReq req,
                                                   Principal principal) {
        CommentView cv = service.create(principal.getName(), vulnUuid, req.content, req.parentUuid);
        Map<String, Object> data = new HashMap<>(); data.put("comment", cv); return ApiResponse.success(data);
    }

    @DeleteMapping("/{commentUuid}")
    @Operation(summary = "删除评论（软删）")
    @org.springframework.security.access.prepost.PreAuthorize("hasAnyRole('USER','ADMIN')")
    public ApiResponse<Void> delete(@PathVariable("uuid") String vulnUuid,
                                    @PathVariable("commentUuid") String commentUuid,
                                    Principal principal) {
        service.delete(principal.getName(), vulnUuid, commentUuid);
        return ApiResponse.success(null);
    }
}

