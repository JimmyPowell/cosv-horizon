package tech.cspioneer.backend.service;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import tech.cspioneer.backend.common.ApiException;
import tech.cspioneer.backend.entity.Organization;
import tech.cspioneer.backend.entity.User;
import tech.cspioneer.backend.entity.VulnerabilityMetadata;
import tech.cspioneer.backend.mapper.*;
import tech.cspioneer.backend.security.ApiKeyContext;

import java.time.Instant;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class VulnerabilityServiceScopeTests {

    @Mock VulnerabilityMetadataMapper vmMapper;
    @Mock VulnerabilityProjectMapper projectMapper;
    @Mock TagMapper tagMapper;
    @Mock LnkVulnTagMapper linkTagMapper;
    @Mock CosvGeneratedIdMapper idMapper;
    @Mock CosvFileMapper cosvFileMapper;
    @Mock UserMapper userMapper;
    @Mock OrganizationMapper organizationMapper;
    @Mock LnkUserOrganizationMapper lnkUserOrgMapper;
    @Mock NotificationMapper notificationMapper;
    @Mock CategoryMapper categoryMapper;

    @InjectMocks VulnerabilityService service;

    @BeforeEach
    void setupAuth() {
        UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken("user-uuid", null);
        ApiKeyContext ctx = new ApiKeyContext();
        ctx.setSubjectType("ORG");
        ctx.setOrgUuid("org-A");
        auth.setDetails(ctx);
        SecurityContextHolder.getContext().setAuthentication(auth);
    }

    @AfterEach
    void clear() { SecurityContextHolder.clearContext(); }

    @Test
    void getByUuid_crossOrg_forbidden() {
        VulnerabilityMetadata vm = new VulnerabilityMetadata(); vm.setId(10L); vm.setOrganizationId(2L);
        when(vmMapper.findByUuid(eq("vm-uuid"))).thenReturn(vm);
        Organization org = new Organization(); org.setId(1L); org.setUuid("org-A");
        when(organizationMapper.findByUuid(eq("org-A"))).thenReturn(org);
        ApiException ex = assertThrows(ApiException.class, () -> service.getByUuid("vm-uuid"));
        assertEquals(1012, ex.getCode());
    }
}
