package tech.cspioneer.backend.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import org.springframework.web.bind.annotation.*;
import tech.cspioneer.backend.common.ApiResponse;
import tech.cspioneer.backend.entity.VulnerabilityMetadata;
import tech.cspioneer.backend.entity.VulnerabilityProject;
import tech.cspioneer.backend.service.VulnerabilityService;
import tech.cspioneer.backend.mapper.TagMapper;
import tech.cspioneer.backend.mapper.CategoryMapper;

import java.security.Principal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/orgs/{orgUuid}/vulns")
@Tag(name = "组织漏洞（REST 风格）")
@SecurityRequirement(name = "bearerAuth")
public class OrgVulnerabilityController {
    private final VulnerabilityService service;
    private final TagMapper tagMapper;
    private final CategoryMapper categoryMapper;

    public OrgVulnerabilityController(VulnerabilityService service, TagMapper tagMapper, CategoryMapper categoryMapper) {
        this.service = service;
        this.tagMapper = tagMapper;
        this.categoryMapper = categoryMapper;
    }

    public static class CreateReqOrg {
        @NotBlank public String summary;
        @NotBlank public String details;
        @NotNull public Float severityNum;
        @NotBlank public String language;
        public String categoryCode;
        public List<String> tags;      // 兼容：按名称传入（弃用）
        public List<String> tagCodes;  // 新字段：按 code 传入
        public List<ProjectReq> projects;
        @io.swagger.v3.oas.annotations.media.Schema(description = "可选：完整COSV负载（导入时可一并提交）")
        public tech.cspioneer.backend.dto.CosvUpsert cosv;
    }

    public static class ProjectReq {
        @NotBlank public String name;
        public String url;
        public String versions;
        public String type;
    }

    @PostMapping
    @Operation(summary = "创建漏洞（组织维度）")
    @org.springframework.security.access.prepost.PreAuthorize("hasAnyRole('USER','ADMIN') or hasAuthority('SCOPE_vuln:write')")
    public ApiResponse<Map<String, Object>> create(@PathVariable("orgUuid") String orgUuid,
                                                   @Valid @RequestBody CreateReqOrg req,
                                                   Principal principal) {
        List<VulnerabilityProject> projects = null;
        if (req.projects != null) {
            projects = req.projects.stream().map(pr -> {
                VulnerabilityProject p = new VulnerabilityProject();
                p.setName(pr.name); p.setUrl(pr.url); p.setVersions(pr.versions); p.setType(pr.type);
                return p;
            }).toList();
        }
        List<String> tagKeys = (req.tagCodes != null && !req.tagCodes.isEmpty()) ? req.tagCodes : req.tags;
        VulnerabilityMetadata vm = service.create(principal.getName(), orgUuid, req.summary, req.details, req.severityNum, req.language, req.categoryCode, tagKeys, projects, req.cosv);
        Map<String, Object> data = new HashMap<>();
        data.put("vulnerability", tech.cspioneer.backend.controller.VulnerabilityControllerHelper.vmView(vm, tagMapper, categoryMapper));
        data.put("cosv", service.buildCosvView(vm));
        return ApiResponse.success(data);
    }

    @GetMapping
    @Operation(summary = "漏洞分页列表（组织维度）")
    @org.springframework.security.access.prepost.PreAuthorize("hasAnyRole('USER','ADMIN') or hasAuthority('SCOPE_vuln:read')")
    public ApiResponse<Map<String, Object>> list(@PathVariable("orgUuid") String orgUuid,
                                                 @RequestParam(value = "language", required = false) String language,
                                                 @RequestParam(value = "status", required = false) String status,
                                                 @RequestParam(value = "identifierPrefix", required = false) String identifierPrefix,
                                                 @Parameter(description = "标签名称（兼容，已弃用）", deprecated = true) @RequestParam(value = "tag", required = false) String tag,
                                                 @Parameter(description = "标签代码（推荐）") @RequestParam(value = "tagCode", required = false) String tagCode,
                                                 @RequestParam(value = "category", required = false) String category,
                                                 @RequestParam(value = "submittedFrom", required = false) String submittedFrom,
                                                 @RequestParam(value = "submittedTo", required = false) String submittedTo,
                                                 @RequestParam(value = "modifiedFrom", required = false) String modifiedFrom,
                                                 @RequestParam(value = "modifiedTo", required = false) String modifiedTo,
                                                 @RequestParam(value = "sortBy", required = false) String sortBy,
                                                 @RequestParam(value = "sortOrder", required = false) String sortOrder,
                                                 @RequestParam(value = "page", required = false, defaultValue = "1") int page,
                                                 @RequestParam(value = "size", required = false, defaultValue = "20") int size,
                                                 @RequestParam(value = "withTotal", required = false, defaultValue = "false") boolean withTotal) {
        var items = service.list(
                language, status, identifierPrefix,
                null, // q
                null, // languagesCSV
                null, // severityLevelsCSV
                null, // severityGe
                null, // severityLe
                tag, tagCode,
                null, // mine
                orgUuid,
                category,
                submittedFrom, submittedTo, modifiedFrom, modifiedTo,
                sortBy, sortOrder,
                page, size);
        Map<String, Object> data = new HashMap<>();
        data.put("page", page);
        data.put("size", size);
        data.put("items", items.stream().map(vm -> tech.cspioneer.backend.controller.VulnerabilityControllerHelper.vmView(vm, tagMapper, categoryMapper)).toList());
        if (withTotal) {
            long total = service.count(
                    language, status, identifierPrefix,
                    null, // q
                    null, // languagesCSV
                    null, // severityLevelsCSV
                    null, // severityGe
                    null, // severityLe
                    tag, tagCode,
                    null, // mine
                    orgUuid,
                    category,
                    submittedFrom, submittedTo, modifiedFrom, modifiedTo);
            data.put("total", total);
        }
        return ApiResponse.success(data);
    }
}
